<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MPGO Monitor - Intelig√™ncia Reputacional</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --mp-blue: #003366;
      --mp-blue-light: #004d99;
      --bg-page: #f3f4f6;
      --bg-card: #ffffff;
      --risk-critical: #ef4444;
      --risk-high: #f97316;
      --risk-medium: #eab308;
      --risk-low: #22c55e;
      --text-main: #111827;
      --text-muted: #6b7280;
      --radius: 12px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: var(--bg-page); color: var(--text-main); padding-bottom: 40px; }

    .header { background: var(--mp-blue); color: white; padding: 1.5rem 0; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); margin-bottom: 2rem; }
    .header-content { max-width: 1200px; margin: 0 auto; padding: 0 1.5rem; display: flex; align-items: center; gap: 1rem; }
    .logo-badge { font-size: 2rem; background: rgba(255,255,255,0.1); padding: 8px; border-radius: 8px; }
    .header h1 { font-size: 1.25rem; font-weight: 700; }
    .header p { font-size: 0.875rem; opacity: 0.8; }

    .container { max-width: 1200px; margin: 0 auto; padding: 0 1.5rem; }

    .search-card {
      background: var(--bg-card); border-radius: var(--radius); padding: 1.5rem;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem; border: 1px solid #e5e7eb;
    }
    .search-input-group { flex: 1; }
    .search-input-group label { display: block; font-size: 0.75rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.5rem; text-transform: uppercase; }
    .search-input { width: 100%; padding: 0.75rem 1rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; }
    .search-input:focus { outline: none; border-color: var(--mp-blue); }

    .btn-action { height: 52px; border-radius: 8px; font-weight: 600; cursor: pointer; padding: 0 1.5rem; margin-top: 1.2rem; border: none; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem; transition: transform 0.1s; }
    .btn-search { background: var(--mp-blue); color: white; }
    .btn-search:hover { background: var(--mp-blue-light); }
    .btn-report { background: #4b5563; color: white; display: none; }
    .btn-report:hover { background: #374151; }
    .btn-clear { background: #fee2e2; color: #dc2626; display: none; }

    .status-bar { margin-top: 1rem; font-size: 0.875rem; font-weight: 500; padding: 0.75rem; border-radius: 8px; display: none; text-align: center; }
    .status-loading { background: #eff6ff; color: var(--mp-blue); }
    .status-ready { background: #f0fdf4; color: var(--risk-low); border: 1px solid #dcfce7; }
    .status-error { background: #fef2f2; color: var(--risk-critical); border: 1px solid #fee2e2; }

    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
    .card { background: var(--bg-card); border-radius: var(--radius); padding: 1.5rem; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); border: 1px solid #e5e7eb; display: flex; flex-direction: column; }
    .card h3 { font-size: 0.875rem; font-weight: 600; color: var(--text-muted); margin-bottom: 1rem; text-transform: uppercase; }

    .metric-big { font-size: 2.5rem; font-weight: 800; color: var(--text-main); margin-top: auto; }
    .risk-meter-container { margin-top: auto; }
    .risk-bar-bg { height: 12px; background: #e5e7eb; border-radius: 6px; overflow: hidden; margin-top: 0.5rem; }
    .risk-bar-fill { height: 100%; width: 0%; transition: width 1s ease; }

    .bg-critical { background: var(--risk-critical); }
    .bg-high { background: var(--risk-high); }
    .bg-medium { background: var(--risk-medium); }
    .bg-low { background: var(--risk-low); }
    .text-critical { color: var(--risk-critical); }
    .text-high { color: var(--risk-high); }
    .text-medium { color: var(--risk-medium); }
    .text-low { color: var(--risk-low); }

    .results-section { background: var(--bg-card); border-radius: var(--radius); box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); border: 1px solid #e5e7eb; overflow: hidden; }
    .results-header { padding: 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }

    .filters { display: flex; gap: 0.5rem; }
    .filter-btn { background: transparent; border: 1px solid #e5e7eb; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; font-weight: 500; color: var(--text-muted); cursor: pointer; }
    .filter-btn:hover { background: #f9fafb; }
    .filter-btn.active { background: var(--mp-blue); color: white; border-color: var(--mp-blue); }

    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 1rem 1.5rem; font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); font-weight: 600; background: #f9fafb; border-bottom: 1px solid #e5e7eb; }
    td { padding: 1.25rem 1.5rem; border-bottom: 1px solid #e5e7eb; vertical-align: top; }
    tr:last-child td { border-bottom: none; }
    tr:hover { background: #f9fafb; }

    .badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 99px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
    .badge-sentiment-positive { background: #dcfce7; color: #166534; }
    .badge-sentiment-neutral { background: #f3f4f6; color: #4b5563; }
    .badge-sentiment-negative { background: #fee2e2; color: #991b1b; }

    .badge-risk { display: flex; align-items: center; gap: 0.5rem; font-weight: 600; font-size: 0.875rem; }
    .dot { width: 8px; height: 8px; border-radius: 50%; }

    .content-preview { margin-top: 0.25rem; font-size: 0.875rem; color: var(--text-muted); line-height: 1.5; }
    .source-tag { display: inline-block; font-size: 0.75rem; font-weight: 600; color: var(--mp-blue); background: #eff6ff; padding: 2px 8px; border-radius: 4px; margin-bottom: 4px; }
    .btn-link { color: var(--mp-blue); text-decoration: none; font-weight: 600; font-size: 0.875rem; cursor: pointer; background: none; border: none; padding: 0; }
    .btn-link:hover { text-decoration: underline; }
    .chart-box { height: 200px; display: flex; justify-content: center; align-items: center; }

    #fontesModal { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: none; align-items: center; justify-content: center; z-index: 50; }
    #fontesModalInner { background: #ffffff; max-width: 700px; width: 90%; padding: 1.5rem 1.75rem; border-radius: 12px; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); }
    #fontesLista { margin-top: 1rem; max-height: 350px; overflow-y: auto; padding-left: 1rem; }
    #fontesLista li { margin-bottom: 0.75rem; font-size: 0.875rem; color: var(--text-main); }
    #fontesLista a { color: var(--mp-blue); text-decoration: none; word-break: break-all; }

    #analiseModal { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: none; align-items: center; justify-content: center; z-index: 60; }
    #analiseModalInner { background: #ffffff; max-width: 800px; width: 92%; padding: 1.5rem; border-radius: 12px; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); }
    #analiseConteudo { margin-top: 1rem; font-size: 0.9rem; line-height: 1.6; color: #111827; }
    .chip { background:#f3f4f6; border:1px solid #e5e7eb; padding:4px 8px; border-radius:6px; font-size:0.75rem; display:inline-block; }

    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .field { display:flex; flex-direction:column; gap:6px; margin-bottom:10px; }
    .field label { font-size:0.75rem; font-weight:600; color:var(--text-muted); text-transform: uppercase; }
    .field input, .field select { padding:10px; border:1px solid #e5e7eb; border-radius:8px; font-size:0.95rem; }
    .field input:focus, .field select:focus { outline:none; border-color: var(--mp-blue); }
    .small-muted { color: var(--text-muted); font-size: 0.85rem; line-height: 1.4; }

    .btn-mini { border:1px solid #e5e7eb; background:#fff; padding:8px 10px; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.85rem; }
    .btn-mini:hover { background:#f9fafb; }
    .btn-mini.primary { background: var(--mp-blue); color:#fff; border-color: var(--mp-blue); }
    .btn-mini.primary:hover { background: var(--mp-blue-light); }
    .btn-mini.danger { background:#fee2e2; border-color:#fecaca; color:#b91c1c; }
    .btn-mini.danger:hover { background:#fecaca; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #e5e7eb; font-size:0.75rem; color:#374151; background:#fff; }

    @media (max-width: 768px) {
      .search-card { flex-direction: column; align-items: stretch; }
      .btn-action { margin-top: 0.5rem; }
      .filters { width: 100%; overflow-x: auto; padding-bottom: 4px; }
      td, th { padding: 1rem; }
      .form-row { grid-template-columns: 1fr; }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
  <header class="header">
    <div class="header-content">
      <div class="logo-badge">‚öñÔ∏è</div>
      <div>
        <h1>MPGO Monitor</h1>
        <p>Coordenadoria de Seguran√ßa Institucional e Intelig√™ncia - An√°lise Reputacional</p>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="search-card">
      <div class="search-input-group">
        <label>Monitoramento de T√≥pico (√öltimas 48h)</label>
        <input type="text" id="termoBusca" class="search-input" placeholder='Ex: "GAECO", "Opera√ß√£o X", "Minist√©rio P√∫blico"'>
      </div>
      <button class="btn-action btn-search" onclick="buscarNoticias()">üîç Investigar (IA)</button>
      <button class="btn-action btn-report" id="reportBtn" onclick="gerarRelatorio()">üìÑ Gerar Relat√≥rio</button>
      <button class="btn-action btn-clear" id="clearBtn" onclick="clearData()">Limpar</button>
    </div>

    <div id="statusIndicator" class="status-bar"></div>

    <!-- NOVO: GERENCIAR ALERTAS -->
    <div class="card" style="margin-bottom: 1.5rem;">
      <h3>Gerenciar alertas</h3>
      <div class="small-muted" style="margin-bottom:10px;">
        Cadastre termos como ‚ÄúGoogle Alerts‚Äù, mas com an√°lise autom√°tica e envio via Telegram. Os alertas rodam conforme interval_minutes.
      </div>

      <div class="form-row">
        <div class="field">
          <label>Nome do alerta</label>
          <input id="a_name" type="text" placeholder="Ex: MPGO - Institucional">
        </div>
        <div class="field">
          <label>Query (termo)</label>
          <input id="a_query" type="text" placeholder='Ex: "MPGO" ou "Cyro Terra Peres"'>
        </div>
      </div>

      <div class="form-row">
        <div class="field">
          <label>Foco</label>
          <select id="a_focus">
            <option value="institutional">institutional</option>
            <option value="query">query</option>
          </select>
        </div>
        <div class="field">
          <label>Risco m√≠nimo</label>
          <select id="a_min_risk">
            <option value="baixo">baixo</option>
            <option value="medio" selected>medio</option>
            <option value="alto">alto</option>
            <option value="critico">critico</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="field">
          <label>Intervalo (min)</label>
          <input id="a_interval" type="number" min="5" max="1440" value="30">
        </div>
        <div class="field">
          <label>Prioridade (1-5)</label>
          <input id="a_priority" type="number" min="1" max="5" value="3">
        </div>
      </div>

      <div class="form-row">
        <div class="field">
          <label>Habilitado</label>
          <select id="a_enabled">
            <option value="true" selected>true</option>
            <option value="false">false</option>
          </select>
        </div>
        <div class="field">
          <label>Authority override</label>
          <select id="a_authority">
            <option value="false" selected>false</option>
            <option value="true">true</option>
          </select>
        </div>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:8px;">
        <button class="btn-mini primary" onclick="saveAlert()">Salvar alerta</button>
        <button class="btn-mini" onclick="resetAlertForm()">Limpar formul√°rio</button>
        <span class="pill" id="editingPill" style="display:none;">Editando: <span id="editingId"></span></span>
      </div>

      <div style="margin-top:16px; border-top:1px solid #e5e7eb; padding-top:12px;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
          <div style="font-weight:700;">Alertas cadastrados</div>
          <button class="btn-mini" onclick="loadAlerts()">Atualizar lista</button>
        </div>
        <div id="alertsBox" style="margin-top:10px;"></div>
      </div>
    </div>

    <div id="dashboardContent" style="display: none;">
      <div id="executiveReport" style="display:none; background: #fff; border-left: 5px solid var(--mp-blue); padding: 1.5rem; margin-bottom: 2rem; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
        <h3 style="color: var(--mp-blue); margin-top: 0; display:flex; align-items:center; gap:8px;">
          üìä Briefing de Intelig√™ncia
          <span style="font-size:0.7em; background:#eff6ff; color:var(--mp-blue); padding:2px 8px; border-radius:12px;">Gerado por IA</span>
        </h3>
        <div id="briefingText" style="font-size: 1rem; line-height: 1.6; color: #374151; white-space: pre-line;"></div>
      </div>

      <div class="grid">
        <div class="card">
          <h3>Risco Ponderado</h3>
          <div class="risk-meter-container">
            <div style="display: flex; justify-content: space-between; align-items: end;">
              <span class="metric-big" id="riskScore">0.0</span>
              <span style="font-weight: 600; margin-bottom: 8px;" id="riskLabel">BAIXO</span>
            </div>
            <div class="risk-bar-bg">
              <div class="risk-bar-fill bg-low" id="riskFill"></div>
            </div>
          </div>
        </div>
        <div class="card">
          <h3>Sentimento</h3>
          <div class="chart-box"><canvas id="sentimentChart"></canvas></div>
        </div>
        <div class="card">
          <h3>Gravidade</h3>
          <div class="chart-box"><canvas id="riskChart"></canvas></div>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <h3>Narrativas em Circula√ß√£o</h3>
          <ul id="narrativesList" style="font-size:0.9rem; line-height:1.5; padding-left: 1rem;"></ul>
        </div>

        <div class="card">
          <h3>A√ß√µes Recomendadas</h3>
          <ul id="actionsList" style="font-size:0.9rem; line-height:1.5; padding-left: 1rem;"></ul>
        </div>

        <div class="card">
          <h3>Watchlist</h3>
          <div id="watchlistBox" style="display:flex; flex-wrap:wrap; gap:6px;"></div>
        </div>
      </div>

      <div class="results-section">
        <div class="results-header">
          <h3 style="margin:0; font-size:1.1rem; color:var(--text-main);">Dossi√™ de Eventos Detectados</h3>
          <div class="filters">
            <button class="filter-btn active" data-filter="all">Todos</button>
            <button class="filter-btn" data-filter="negative">üî¥ Negativo</button>
            <button class="filter-btn" data-filter="neutral">‚ö™ Neutro</button>
            <button class="filter-btn" data-filter="positive">üü¢ Positivo</button>
          </div>
        </div>

        <div style="overflow-x: auto;">
          <table id="newsTable">
            <thead>
              <tr>
                <th style="width: 15%;">Data</th>
                <th style="width: 45%;">Evento / S√≠ntese T√©cnica</th>
                <th style="width: 15%;">Sentimento</th>
                <th style="width: 15%;">Risco (IA)</th>
                <th style="width: 10%;">A√ß√µes</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div id="tableEmpty" style="padding: 3rem; text-align: center; color: var(--text-muted);">
          Nenhum resultado encontrado.
        </div>
      </div>
    </div>
  </div>

  <div id="fontesModal">
    <div id="fontesModalInner">
      <h3 style="margin:0; font-size:1rem; font-weight:700;">Fontes do evento</h3>
      <p id="fontesModalResumo" style="margin-top:0.5rem; font-size:0.875rem; color:var(--text-muted);"></p>
      <ul id="fontesLista"></ul>
      <div style="margin-top:1.5rem; text-align:right;">
        <button class="btn-mini" onclick="fecharFontes()">Fechar</button>
      </div>
    </div>
  </div>

  <div id="analiseModal">
    <div id="analiseModalInner">
      <h3 style="margin:0; font-size:1rem; font-weight:700;">An√°lise Estrat√©gica</h3>
      <div id="analiseConteudo"></div>
      <div style="margin-top:1.25rem; text-align:right;">
        <button class="btn-mini" onclick="fecharAnalise()">Fechar</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'https://monitormpgo.lennontld.workers.dev';

    let newsData = [];
    let currentFilter = 'all';
    let chartSentiment = null;
    let chartRisk = null;

    let editingAlertId = null;

    // ----- init -----
    window.addEventListener('load', () => {
      loadAlerts();
    });

    // ======================================
    // ALERTS UI
    // ======================================
    async function loadAlerts() {
      const box = document.getElementById('alertsBox');
      box.innerHTML = '<div class="small-muted">Carregando...</div>';

      try {
        const resp = await fetch(`${API_BASE}/alerts`);
        const data = await resp.json();

        if (!resp.ok || !data.ok) throw new Error(data.erro || 'Falha ao carregar alertas');

        const alerts = Array.isArray(data.alerts) ? data.alerts : [];
        if (!alerts.length) {
          box.innerHTML = '<div class="small-muted">Nenhum alerta cadastrado.</div>';
          return;
        }

        // ordena por prioridade desc
        alerts.sort((a,b) => (Number(b.priority||0) - Number(a.priority||0)));

        box.innerHTML = `
          <div style="overflow-x:auto;">
            <table>
              <thead>
                <tr>
                  <th style="width:18%;">Nome</th>
                  <th style="width:24%;">Query</th>
                  <th style="width:10%;">Foco</th>
                  <th style="width:10%;">Min risco</th>
                  <th style="width:10%;">Intervalo</th>
                  <th style="width:10%;">Status</th>
                  <th style="width:18%;">A√ß√µes</th>
                </tr>
              </thead>
              <tbody>
                ${alerts.map(a => `
                  <tr>
                    <td>${sanitizeHtml(a.name || '')}<div class="small-muted">prio: ${sanitizeHtml(String(a.priority||''))}</div></td>
                    <td>
                      <button class="btn-link" onclick="fillSearchFromAlert('${sanitizeAttr(a.query||'')}')">${sanitizeHtml(a.query || '')}</button>
                      <div class="small-muted">id: ${sanitizeHtml(a.id || '')}</div>
                    </td>
                    <td>${sanitizeHtml(a.focus || '')}</td>
                    <td>${sanitizeHtml(a.min_risk || '')}</td>
                    <td>${sanitizeHtml(String(a.interval_minutes || ''))}m</td>
                    <td>${a.enabled ? '<span class="pill">on</span>' : '<span class="pill">off</span>'}</td>
                    <td>
                      <button class="btn-mini" onclick="editAlert('${sanitizeAttr(a.id)}')">Editar</button>
                      <button class="btn-mini" onclick="toggleAlert('${sanitizeAttr(a.id)}', ${a.enabled ? 'false':'true'})">${a.enabled ? 'Desativar' : 'Ativar'}</button>
                      <button class="btn-mini" onclick="runAlertNow('${sanitizeAttr(a.id)}')">Rodar</button>
                      <button class="btn-mini danger" onclick="deleteAlert('${sanitizeAttr(a.id)}')">Excluir</button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
      } catch (e) {
        box.innerHTML = `<div class="small-muted" style="color:#b91c1c;">Erro: ${sanitizeHtml(e.message)}</div>`;
      }
    }

    function resetAlertForm() {
      editingAlertId = null;
      document.getElementById('a_name').value = '';
      document.getElementById('a_query').value = '';
      document.getElementById('a_focus').value = 'institutional';
      document.getElementById('a_min_risk').value = 'medio';
      document.getElementById('a_interval').value = 30;
      document.getElementById('a_priority').value = 3;
      document.getElementById('a_enabled').value = 'true';
      document.getElementById('a_authority').value = 'false';
      document.getElementById('editingPill').style.display = 'none';
    }

    async function editAlert(id) {
      // busca lista e preenche form (simples e suficiente)
      const resp = await fetch(`${API_BASE}/alerts`);
      const data = await resp.json();
      const alerts = Array.isArray(data.alerts) ? data.alerts : [];
      const a = alerts.find(x => x.id === id);
      if (!a) return;

      editingAlertId = a.id;

      document.getElementById('a_name').value = a.name || '';
      document.getElementById('a_query').value = a.query || '';
      document.getElementById('a_focus').value = a.focus || 'institutional';
      document.getElementById('a_min_risk').value = a.min_risk || 'medio';
      document.getElementById('a_interval').value = Number(a.interval_minutes || 30);
      document.getElementById('a_priority').value = Number(a.priority || 3);
      document.getElementById('a_enabled').value = String(!!a.enabled);
      document.getElementById('a_authority').value = String(!!a.authority_override);

      document.getElementById('editingId').textContent = a.id;
      document.getElementById('editingPill').style.display = 'inline-block';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function saveAlert() {
      const payload = {
        id: editingAlertId || undefined,
        name: document.getElementById('a_name').value.trim(),
        query: document.getElementById('a_query').value.trim(),
        focus: document.getElementById('a_focus').value,
        min_risk: document.getElementById('a_min_risk').value,
        interval_minutes: Number(document.getElementById('a_interval').value || 30),
        priority: Number(document.getElementById('a_priority').value || 3),
        enabled: document.getElementById('a_enabled').value === 'true',
        authority_override: document.getElementById('a_authority').value === 'true',
        channels: ["telegram"]
      };

      if (!payload.name || !payload.query) {
        alert('Preencha nome e query.');
        return;
      }

      const resp = await fetch(`${API_BASE}/alerts`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await resp.json().catch(() => ({}));

      if (!resp.ok || !data.ok) {
        alert(data.erro || 'Falha ao salvar');
        return;
      }

      resetAlertForm();
      await loadAlerts();
      alert('Alerta salvo.');
    }

    async function deleteAlert(id) {
      if (!confirm('Excluir este alerta?')) return;

      const resp = await fetch(`${API_BASE}/alerts?id=${encodeURIComponent(id)}`, { method: 'DELETE' });
      const data = await resp.json().catch(() => ({}));

      if (!resp.ok || !data.ok) {
        alert(data.erro || 'Falha ao excluir');
        return;
      }
      await loadAlerts();
    }

    async function toggleAlert(id, enabled) {
      // Toggle via UPSERT simples: carrega, ajusta e salva
      const resp = await fetch(`${API_BASE}/alerts`);
      const data = await resp.json();
      const alerts = Array.isArray(data.alerts) ? data.alerts : [];
      const a = alerts.find(x => x.id === id);
      if (!a) return;

      a.enabled = !!enabled;

      const resp2 = await fetch(`${API_BASE}/alerts`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(a)
      });
      const data2 = await resp2.json().catch(() => ({}));

      if (!resp2.ok || !data2.ok) {
        alert(data2.erro || 'Falha ao alternar');
        return;
      }
      await loadAlerts();
    }

    async function runAlertNow(id) {
      const resp = await fetch(`${API_BASE}/run-alerts`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id })
      });
      const data = await resp.json().catch(() => ({}));
      if (!resp.ok || !data.ok) {
        alert(data.erro || 'Falha ao executar');
        return;
      }
      alert('Alerta executado. Se houver novidades e passar no filtro, vai enviar no Telegram.');
    }

    function fillSearchFromAlert(q) {
      document.getElementById('termoBusca').value = q;
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ======================================
    // BUSCA MANUAL (o que voc√™ j√° tinha)
    // ======================================
    async function buscarNoticias() {
      const termo = document.getElementById('termoBusca').value.trim();
      if (!termo) { alert('Digite um termo para investigar.'); return; }

      showStatus(`Investigando "${termo}" em Google, YouTube e RSS...`, 'loading');

      try {
        const resp = await fetch(`${API_BASE}/unified-search?q=${encodeURIComponent(termo)}`);
        if (!resp.ok) {
          const errData = await resp.json().catch(() => ({}));
          throw new Error(errData.erro || 'Erro na conex√£o');
        }

        const data = await resp.json();

        newsData = (data.results || []).map(item => ({
          title: item.title,
          content: item.content || item.sintese_tecnica || "Sem resumo.",
          url: item.url,
          source: item.source,
          date: item.date,
          sentiment: mapSentiment(item.sentimento || item.sentiment),
          riskScore: (item.risco_score || 0).toFixed(1),
          riskLevel: mapRiskLevel(item.risco_classificacao),
          sources: Array.isArray(item.sources) ? item.sources : [],
          narrativa: item.narrativa_principal || '',
          sensiveis: Array.isArray(item.pontos_sensiveis) ? item.pontos_sensiveis : [],
          vetores: Array.isArray(item.vetores_provaveis) ? item.vetores_provaveis : [],
          mensagemBase: item.mensagem_base_sugerida || ''
        }));

        if (newsData.length === 0) {
          showStatus('Nenhum evento relevante encontrado nas √∫ltimas 48h.', 'ready');
          document.getElementById('dashboardContent').style.display = 'none';
          document.getElementById('reportBtn').style.display = 'none';
          document.getElementById('clearBtn').style.display = 'inline-flex';
          return;
        }

        document.getElementById('dashboardContent').style.display = 'block';
        document.getElementById('clearBtn').style.display = 'inline-flex';
        document.getElementById('reportBtn').style.display = 'inline-flex';

        if (data.executive_briefing) {
          document.getElementById('briefingText').textContent = data.executive_briefing;
          document.getElementById('executiveReport').style.display = 'block';
        } else {
          document.getElementById('executiveReport').style.display = 'none';
        }

        updateDashboard();

        if (data.report) renderStrategicPanels(data.report);
        else renderStrategicPanels({ narratives: [], recommended_actions: [], watchlist: [] });

        showStatus(`An√°lise conclu√≠da: ${data.total_raw || 0} men√ß√µes em ${data.total_clusters || 0} eventos.`, 'ready');
      } catch (e) {
        console.error(e);
        showStatus('Erro: ' + e.message, 'error');
      }
    }

    function gerarRelatorio() { window.print(); }

    function updateDashboard() { updateMetrics(); updateCharts(); updateTable(); }

    function updateMetrics() {
      if (newsData.length === 0) return;
      const avgRisk = newsData.reduce((acc, curr) => acc + parseFloat(curr.riskScore), 0) / newsData.length;
      const scoreEl = document.getElementById('riskScore');
      const labelEl = document.getElementById('riskLabel');
      const fillEl = document.getElementById('riskFill');

      scoreEl.textContent = avgRisk.toFixed(1);

      let levelClass = 'bg-low';
      let labelText = 'BAIXO';
      if (avgRisk >= 80) { levelClass = 'bg-critical'; labelText = 'CR√çTICO'; }
      else if (avgRisk >= 60) { levelClass = 'bg-high'; labelText = 'ALTO'; }
      else if (avgRisk >= 30) { levelClass = 'bg-medium'; labelText = 'M√âDIO'; }

      labelEl.textContent = labelText;
      labelEl.className = levelClass.replace('bg-', 'text-');
      fillEl.className = `risk-bar-fill ${levelClass}`;
      setTimeout(() => { fillEl.style.width = `${Math.min(avgRisk, 100)}%`; }, 100);
    }

    function updateTable() {
      const tbody = document.querySelector('#newsTable tbody');
      const emptyDiv = document.getElementById('tableEmpty');

      const filtered = newsData.filter(item => currentFilter === 'all' || item.sentiment === currentFilter);
      filtered.sort((a, b) => parseFloat(b.riskScore) - parseFloat(a.riskScore));

      if (filtered.length === 0) {
        tbody.innerHTML = '';
        emptyDiv.style.display = 'block';
        return;
      }
      emptyDiv.style.display = 'none';

      tbody.innerHTML = filtered.map((item, idx) => {
        const totalFontes = item.sources ? item.sources.length : 0;
        return `
        <tr>
          <td><div style="font-size:0.85rem; color:var(--text-muted);">${formatDate(item.date)}</div></td>
          <td>
            <span class="source-tag">${sanitizeHtml(item.source || 'Fonte')}</span>
            <div style="font-weight:600; margin-bottom:4px;">${sanitizeHtml(item.title || '')}</div>
            <div class="content-preview">${sanitizeHtml(item.content || '')}</div>
          </td>
          <td><span class="badge badge-sentiment-${item.sentiment}">${translateSentiment(item.sentiment)}</span></td>
          <td>
            <div class="badge-risk">
              <div class="dot bg-${item.riskLevel}"></div>
              <span class="text-${item.riskLevel}">${sanitizeHtml(item.riskScore)}</span>
            </div>
          </td>
          <td>
            <button class="btn-link" onclick="abrirFontes(${idx})">Fontes (${totalFontes || 1})</button><br>
            <button class="btn-link" onclick="abrirAnalise(${idx})">An√°lise</button><br>
            <a class="btn-link" href="${sanitizeAttr(item.url)}" target="_blank" rel="noopener noreferrer">Abrir</a>
          </td>
        </tr>`;
      }).join('');
    }

    function updateCharts() {
      const sentData = [
        newsData.filter(n => n.sentiment === 'positive').length,
        newsData.filter(n => n.sentiment === 'neutral').length,
        newsData.filter(n => n.sentiment === 'negative').length
      ];

      const ctxSent = document.getElementById('sentimentChart');
      if (chartSentiment) chartSentiment.destroy();
      chartSentiment = new Chart(ctxSent, {
        type: 'doughnut',
        data: {
          labels: ['Positivo', 'Neutro', 'Negativo'],
          datasets: [{ data: sentData, backgroundColor: ['#22c55e', '#9ca3af', '#ef4444'], borderWidth: 0 }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
      });

      const riskCounts = { critical:0, high:0, medium:0, low:0 };
      newsData.forEach(n => riskCounts[n.riskLevel]++);

      const ctxRisk = document.getElementById('riskChart');
      if (chartRisk) chartRisk.destroy();
      chartRisk = new Chart(ctxRisk, {
        type: 'bar',
        data: {
          labels: ['Baixo', 'M√©dio', 'Alto', 'Cr√≠tico'],
          datasets: [{ label: 'Eventos', data: [riskCounts.low, riskCounts.medium, riskCounts.high, riskCounts.critical], backgroundColor: ['#22c55e', '#eab308', '#f97316', '#ef4444'], borderRadius: 4 }]
        },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { display: false } } }, plugins: { legend: { display: false } } }
      });
    }

    function renderStrategicPanels(report) {
      const nList = document.getElementById('narrativesList');
      const aList = document.getElementById('actionsList');
      const wBox = document.getElementById('watchlistBox');

      if (report?.narratives?.length) {
        nList.innerHTML = report.narratives.map(n => `<li>‚Ä¢ ${sanitizeHtml(n.text)} <span style="color:var(--text-muted)">(${sanitizeHtml(String(n.count))})</span></li>`).join('');
      } else {
        nList.innerHTML = `<li style="color:var(--text-muted)">Nenhuma narrativa relevante detectada.</li>`;
      }

      if (report?.recommended_actions?.length) {
        aList.innerHTML = report.recommended_actions.map(a => `<li>‚Ä¢ ${sanitizeHtml(a)}</li>`).join('');
      } else {
        aList.innerHTML = `<li style="color:var(--text-muted)">Nenhuma a√ß√£o sugerida.</li>`;
      }

      if (report?.watchlist?.length) {
        wBox.innerHTML = report.watchlist.map(t => `<span class="chip">${sanitizeHtml(t)}</span>`).join('');
      } else {
        wBox.innerHTML = `<span style="color:var(--text-muted)">‚Äî</span>`;
      }
    }

    function abrirAnalise(index) {
      const item = newsData[index];
      if (!item) return;

      const sensiveis = Array.isArray(item.sensiveis) && item.sensiveis.length
        ? `<ul style="margin-top:6px; padding-left: 1.1rem;">${item.sensiveis.map(s => `<li>${sanitizeHtml(s)}</li>`).join('')}</ul>`
        : `<div style="color:var(--text-muted); margin-top:6px;">‚Äî</div>`;

      const vetores = Array.isArray(item.vetores) && item.vetores.length
        ? item.vetores.map(v => `<span class="chip">${sanitizeHtml(v)}</span>`).join(' ')
        : `<span style="color:var(--text-muted)">‚Äî</span>`;

      const msgBase = item.mensagemBase ? sanitizeHtml(item.mensagemBase) : '‚Äî';

      document.getElementById('analiseConteudo').innerHTML = `
        <div style="font-weight:600; margin-bottom:6px;">Evento</div>
        <div style="color:#374151;">${sanitizeHtml(item.title || '')}</div>

        <div style="margin-top:12px; font-weight:600; margin-bottom:6px;">Narrativa identificada</div>
        <div style="color:#374151;">${sanitizeHtml(item.narrativa || '‚Äî')}</div>

        <div style="margin-top:12px; font-weight:600; margin-bottom:6px;">Pontos sens√≠veis</div>
        ${sensiveis}

        <div style="margin-top:12px; font-weight:600; margin-bottom:6px;">Vetores prov√°veis</div>
        <div style="display:flex; flex-wrap:wrap; gap:6px;">${vetores}</div>

        <div style="margin-top:12px; font-weight:600; margin-bottom:6px;">Mensagem institucional sugerida</div>
        <div style="margin-top:6px; padding:10px; background:#f9fafb; border:1px solid #e5e7eb; border-radius:8px; white-space:pre-line;">${msgBase}</div>
      `;
      document.getElementById('analiseModal').style.display = 'flex';
    }
    function fecharAnalise() { document.getElementById('analiseModal').style.display = 'none'; }

    function clearData() {
      newsData = [];
      document.getElementById('dashboardContent').style.display = 'none';
      document.getElementById('clearBtn').style.display = 'none';
      document.getElementById('reportBtn').style.display = 'none';
      document.getElementById('statusIndicator').style.display = 'none';
      document.getElementById('termoBusca').value = '';
      if (chartSentiment) { chartSentiment.destroy(); chartSentiment = null; }
      if (chartRisk) { chartRisk.destroy(); chartRisk = null; }
    }

    function showStatus(msg, type) {
      const el = document.getElementById('statusIndicator');
      el.textContent = msg;
      el.className = `status-bar status-${type}`;
      el.style.display = 'block';
    }

    function mapRiskLevel(level) {
      if (!level) return 'low';
      level = level.toLowerCase();
      if (level.includes('critico')) return 'critical';
      if (level.includes('alto')) return 'high';
      if (level.includes('medio')) return 'medium';
      return 'low';
    }

    function mapSentiment(s) {
      if (!s) return 'neutral';
      s = s.toString().toLowerCase();
      if (s.includes('pos')) return 'positive';
      if (s.includes('neg')) return 'negative';
      return 'neutral';
    }

    function translateSentiment(s) {
      if (s === 'positive') return 'Positivo';
      if (s === 'negative') return 'Negativo';
      return 'Neutro';
    }

    function formatDate(isoStr) {
      if (!isoStr) return '-';
      const d = new Date(isoStr);
      return isNaN(d.getTime()) ? isoStr : d.toLocaleDateString('pt-BR') + ' ' + d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
    }

    function abrirFontes(index) {
      const item = newsData[index];
      if (!item) return;

      const lista = document.getElementById('fontesLista');
      document.getElementById('fontesModalResumo').textContent = item.title || '';

      let fontes = item.sources;
      if (!Array.isArray(fontes) || fontes.length === 0) fontes = [{ source: item.source, url: item.url, date: item.date }];

      lista.innerHTML = fontes.map((f, i) => `
        <li>
          <div style="font-weight:700;">${i + 1}. ${sanitizeHtml(f.source || 'Fonte')}</div>
          ${f.date ? `<div style="color:var(--text-muted); font-size:0.85rem; margin-top:2px;">${sanitizeHtml(formatDate(f.date))}</div>` : ''}
          <div style="margin-top:6px;">
            <a href="${sanitizeAttr(f.url || f.link || '#')}" target="_blank" rel="noopener noreferrer">${sanitizeHtml(f.url || f.link || '#')}</a>
          </div>
        </li>`).join('');

      document.getElementById('fontesModal').style.display = 'flex';
    }
    function fecharFontes() { document.getElementById('fontesModal').style.display = 'none'; }

    document.getElementById('fontesModal').addEventListener('click', (e) => { if (e.target.id === 'fontesModal') fecharFontes(); });
    document.getElementById('analiseModal').addEventListener('click', (e) => { if (e.target.id === 'analiseModal') fecharAnalise(); });

    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        currentFilter = e.target.getAttribute('data-filter');
        updateTable();
      });
    });

    function sanitizeHtml(str) {
      const s = (str === null || str === undefined) ? '' : String(str);
      return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
    }
    function sanitizeAttr(url) {
      const u = (url === null || url === undefined) ? '' : String(url);
      if (/^\s*(javascript:|data:)/i.test(u)) return '#';
      return u.replace(/"/g, '%22');
    }
  </script>
</body>
</html>
