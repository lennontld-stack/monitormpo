<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MPGO Monitor - An√°lise de Reputa√ß√£o Executiva</title>
  <style>
    :root {
      --color-critical: #dc2626;
      --color-high: #ea580c;
      --color-medium: #eab308;
      --color-low: #16a34a;
      --color-success: #059669;
      --color-warning: #d97706;
      --color-danger: #dc2626;
      --color-primary: #1e40af;
      --color-secondary: #64748b;
      --color-background: #f8fafc;
      --color-surface: #ffffff;
      --color-surface-2: #f1f5f9;
      --color-text-primary: #0f172a;
      --color-text-secondary: #475569;
      --color-border: #e2e8f0;
      --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      --font-size-sm: 0.875rem;
      --font-size-base: 1rem;
      --font-size-lg: 1.125rem;
      --font-size-xl: 1.25rem;
      --font-size-2xl: 1.5rem;
      --font-weight-normal: 400;
      --font-weight-medium: 500;
      --font-weight-semibold: 600;
      --font-weight-bold: 700;
      --spacing-xs: 0.5rem;
      --spacing-sm: 0.75rem;
      --spacing-md: 1rem;
      --spacing-lg: 1.25rem;
      --spacing-xl: 1.5rem;
      --spacing-2xl: 2rem;
      --spacing-3xl: 3rem;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
      --border-radius: 0.5rem;
      --border-radius-lg: 0.75rem;
      --border-radius-xl: 1rem;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: var(--font-family);
      background: var(--color-background);
      color: var(--color-text-primary);
      line-height: 1.6;
      font-size: var(--font-size-base);
    }
    .header {
      background: linear-gradient(135deg, var(--color-primary) 0%, #1d4ed8 100%);
      color: white;
      padding: var(--spacing-2xl) var(--spacing-3xl);
      box-shadow: var(--shadow-xl);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: var(--spacing-xl);
    }
    .logo {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      font-size: var(--font-size-2xl);
      font-weight: var(--font-weight-bold);
    }
    .logo-icon {
      width: 48px;
      height: 48px;
      background: rgba(255,255,255,0.2);
      border-radius: var(--border-radius-xl);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--font-size-xl);
      font-weight: bold;
    }
    .header-title { font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); }
    .main-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: var(--spacing-xl);
    }
    .input-section {
      background: var(--color-surface);
      border-radius: var(--border-radius-xl);
      padding: var(--spacing-2xl);
      margin-bottom: var(--spacing-2xl);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--color-border);
    }
    .input-group { display: flex; flex-direction: column; gap: var(--spacing-lg); }
    @media (min-width: 768px) {
      .input-group { flex-direction: row; align-items: end; }
      .input-group .input-field { flex: 1; }
    }
    .input-field { flex: 1; }
    .input-field label {
      display: block;
      margin-bottom: var(--spacing-sm);
      font-weight: var(--font-weight-semibold);
      color: var(--color-text-primary);
      font-size: var(--font-size-sm);
    }
    .input-field input {
      width: 100%;
      padding: var(--spacing-md) var(--spacing-lg);
      border: 2px solid var(--color-border);
      border-radius: var(--border-radius-lg);
      font-size: var(--font-size-base);
      transition: all 0.2s ease;
      background: var(--color-surface);
    }
    .input-field input:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
    }
    .btn {
      padding: var(--spacing-lg) var(--spacing-2xl);
      border: none;
      border-radius: var(--border-radius-lg);
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-semibold);
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-sm);
      text-decoration: none;
      min-height: 52px;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--color-primary) 0%, #1d4ed8 100%);
      color: white;
      box-shadow: var(--shadow-lg);
    }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: var(--shadow-xl); }
    .btn-secondary {
      background: var(--color-surface-2);
      color: var(--color-text-primary);
      border: 2px solid var(--color-border);
    }
    .btn-secondary:hover {
      background: var(--color-surface);
      border-color: var(--color-primary);
      color: var(--color-primary);
    }
    .btn-danger { background: var(--color-danger); color: white; }
    .btn-group { display: flex; gap: var(--spacing-md); flex-wrap: wrap; }
    .status-indicator {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      padding: var(--spacing-md) var(--spacing-lg);
      border-radius: var(--border-radius);
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium);
      margin-top: var(--spacing-md);
    }
    .status-ready { background: rgba(22, 163, 74, 0.1); color: var(--color-success); }
    .status-loading { background: rgba(245, 158, 11, 0.1); color: var(--color-warning); }
    .status-error { background: rgba(220, 38, 38, 0.1); color: var(--color-danger); }
    .tabs {
      display: none;
      background: var(--color-surface);
      border-radius: var(--border-radius-xl) var(--border-radius-xl) 0 0;
      box-shadow: var(--shadow-md);
      margin-bottom: 0;
      overflow: hidden;
    }
    .tab {
      flex: 1;
      padding: var(--spacing-lg) var(--spacing-xl);
      background: none;
      border: none;
      font-weight: var(--font-weight-semibold);
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--color-text-secondary);
    }
    .tab.active { background: var(--color-primary); color: white; }
    .tab-content {
      background: var(--color-surface);
      border-radius: 0 0 var(--border-radius-xl) var(--border-radius-xl);
      padding: var(--spacing-2xl);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--color-border);
      border-top: none;
      display: none;
    }
    .tab-content.active { display: block; }
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: var(--spacing-xl);
      margin-bottom: var(--spacing-2xl);
    }
    .card {
      background: var(--color-surface);
      border-radius: var(--border-radius-xl);
      padding: var(--spacing-xl);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--color-border);
    }
    .card-header {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
    }
    .risk-badge {
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--border-radius);
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-bold);
      text-transform: uppercase;
    }
    .risk-critical { background: rgba(220, 38, 38, 0.1); color: var(--color-critical); }
    .risk-high { background: rgba(234, 88, 12, 0.1); color: var(--color-high); }
    .risk-medium { background: rgba(234, 179, 8, 0.1); color: var(--color-medium); }
    .risk-low { background: rgba(22, 163, 74, 0.1); color: var(--color-low); }
    .metric-value {
      font-size: var(--font-size-2xl);
      font-weight: var(--font-weight-bold);
      color: var(--color-text-primary);
    }
    .risk-index-container { text-align: center; }
    .risk-gauge {
      width: 100%; height: 20px;
      background: var(--color-surface-2);
      border-radius: 10px;
      overflow: hidden;
      margin: var(--spacing-lg) 0;
      position: relative;
    }
    .risk-fill { height: 100%; transition: width 1s ease; position: relative; }
    .risk-fill.critical { background: linear-gradient(90deg, var(--color-critical), #b91c1c); }
    .risk-fill.high { background: linear-gradient(90deg, var(--color-high), #c2410c); }
    .risk-fill.medium { background: linear-gradient(90deg, var(--color-medium), #ca8a04); }
    .risk-fill.low { background: linear-gradient(90deg, var(--color-low), #15803d); }
    .risk-label {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      font-weight: var(--font-weight-bold);
      font-size: var(--font-size-lg);
      color: white;
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }
    .chart-container {
      height: 300px;
      position: relative;
      background: var(--color-surface-2);
      border-radius: var(--border-radius-lg);
      padding: var(--spacing-xl);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: var(--spacing-md);
    }
    .sentiment-chart, .risk-chart { width: 100%; height: 250px; }
    .filters {
      display: flex;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-xl);
      flex-wrap: wrap;
      align-items: center;
    }
    .filter-btn {
      padding: var(--spacing-sm) var(--spacing-lg);
      background: var(--color-surface-2);
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: var(--font-size-sm);
    }
    .filter-btn.active {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }
    .table-container {
      overflow-x: auto;
      background: var(--color-surface);
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-md);
    }
    table { width: 100%; border-collapse: collapse; }
    th, td {
      padding: var(--spacing-lg);
      text-align: left;
      border-bottom: 1px solid var(--color-border);
    }
    th {
      background: var(--color-surface-2);
      font-weight: var(--font-weight-semibold);
      font-size: var(--font-size-sm);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--color-text-secondary);
    }
    tr:hover { background: rgba(30, 64, 175, 0.02); }
    .sentiment-badge {
      padding: var(--spacing-xs) var(--spacing-md);
      border-radius: var(--border-radius);
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-semibold);
    }
    .sentiment-positive { background: rgba(22, 163, 74, 0.1); color: var(--color-success); }
    .sentiment-neutral { background: rgba(100, 116, 139, 0.1); color: var(--color-secondary); }
    .sentiment-negative { background: rgba(220, 38, 38, 0.1); color: var(--color-danger); }
    .risk-score { font-weight: var(--font-weight-bold); font-size: var(--font-size-lg); }
    .techniques-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: var(--spacing-lg);
    }
    .technique-item {
      background: var(--color-surface-2);
      border-left: 4px solid var(--color-warning);
      padding: var(--spacing-lg);
      border-radius: 0 var(--border-radius-lg) var(--border-radius-lg) 0;
    }
    .technique-name {
      font-weight: var(--font-weight-bold);
      font-size: var(--font-size-lg);
      margin-bottom: var(--spacing-sm);
    }
    @media (max-width: 768px) {
      .main-container { padding: var(--spacing-md); }
      .header-content { flex-direction: column; text-align: center; gap: var(--spacing-lg); }
      .dashboard-grid { grid-template-columns: 1fr; }
      .btn-group { flex-direction: column; }
    }
  </style>
</head>
<body>
<header class="header">
  <div class="header-content">
    <div class="logo">
      <div class="logo-icon">üö®</div>
      <div>
        <div class="header-title">MPGO Monitor</div>
        <div style="font-size: var(--font-size-sm); opacity: 0.9;">An√°lise Executiva de Reputa√ß√£o</div>
      </div>
    </div>
  </div>
</header>

<main class="main-container">
  <section class="input-section">
    <div class="input-group">
      <div class="input-field">
        <label for="termoBusca">Termo de busca (√∫ltimas 24h)</label>
        <input type="text" id="termoBusca"
               placeholder='Ex.: MPGO OR "gaeco goi√°s" OR "cyro terra peres"'>
      </div>
      <div class="btn-group">
        <button class="btn btn-primary" onclick="buscarNoticias()">üïµÔ∏è Investiga√ß√£o Completa (IA)</button>
        
        <button class="btn btn-secondary" onclick="loadDemoData()">üéØ Dados de Exemplo</button>
        <button class="btn btn-danger" onclick="clearData()" style="display: none;" id="clearBtn">üóëÔ∏è Limpar</button>
      </div>
    </div>
    <div id="statusIndicator" class="status-indicator" style="display: none;"></div>
  </section>

  <div class="tabs" id="tabsContainer">
    <button class="tab active" onclick="switchTab('dashboard', event)">Dashboard</button>
    <button class="tab" onclick="switchTab('techniques', event)">T√©cnicas Detectadas</button>
  </div>

  <div id="dashboardTab" class="tab-content active">
    <div class="dashboard-grid" id="riskCounters"></div>

    <div class="dashboard-grid">
      <div class="card" style="grid-column: span 2;">
        <div class="card-header">
          <div class="risk-badge risk-critical">üìä</div>
          <div>
            <h3 style="margin: 0; font-size: var(--font-size-lg);">√çndice Geral de Risco</h3>
            <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">M√©dia ponderada das √∫ltimas 24h</div>
          </div>
        </div>
        <div class="risk-index-container">
          <div class="risk-gauge">
            <div class="risk-fill" id="riskFill" style="width: 0%;">
              <div class="risk-label" id="riskLabel">0</div>
            </div>
          </div>
          <div id="riskScore" class="metric-value">0.0</div>
          <div id="riskClassification" style="font-size: var(--font-size-sm); opacity: 0.7;">Sem dados</div>
        </div>
      </div>
      <div class="card">
        <h3 style="margin-bottom: var(--spacing-lg);">Distribui√ß√£o de Sentimento</h3>
        <div class="chart-container">
          <canvas id="sentimentChart" class="sentiment-chart"></canvas>
        </div>
      </div>
      <div class="card">
        <h3 style="margin-bottom: var(--spacing-lg);">Distribui√ß√£o de Risco</h3>
        <div class="chart-container">
          <canvas id="riskChart" class="risk-chart"></canvas>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-xl); flex-wrap: wrap; gap: var(--spacing-md);">
        <h3 style="margin: 0;">√öltimas Not√≠cias (Agrupadas por Evento)</h3>
        <div class="filters">
          <input type="date" id="dataIni">
          <input type="date" id="dataFim">
          <button class="filter-btn active" data-filter="all">Todas</button>
          <button class="filter-btn" data-filter="positive">Positivo</button>
          <button class="filter-btn" data-filter="neutral">Neutro</button>
          <button class="filter-btn" data-filter="negative">Negativo</button>
          <button class="filter-btn" onclick="gerarResumoPeriodo()">Resumo / TXT</button>
        </div>
      </div>
      <div class="table-container">
        <table id="newsTable">
          <thead>
          <tr>
            <th>Data</th>
            <th>Evento / S√≠ntese</th>
            <th>Fontes</th>
            <th>Sentimento</th>
            <th>Risco (IA)</th>
            <th>A√ß√µes</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div style="text-align: center; padding: var(--spacing-xl); color: var(--color-text-secondary);">
        <span id="tableEmpty">Clique em "Investiga√ß√£o Completa" para varrer a web e analisar riscos.</span>
      </div>
    </div>
  </div>

  <div id="techniquesTab" class="tab-content">
    <div class="techniques-grid" id="techniquesList"></div>
  </div>
</main>

<script>
const API_BASE = 'https://monitormpgo.lennontld.workers.dev';

let newsData = [];
let historicoCompleto = [];
let currentFilter = 'all';
let currentTab = 'dashboard';

// ============================================
// FUN√á√ÉO PRINCIPAL: BUSCA UNIFICADA (WORKER)
// ============================================
async function buscarNoticias() {
  const termo = document.getElementById('termoBusca').value.trim();
  if (!termo) {
    alert('Informe um termo para busca (ex.: MPGO, GAECO).');
    return;
  }

  // 1. Feedback visual
  showStatus(`üïµÔ∏è Investigando "${termo}" no Google, YouTube e RSS...`, 'loading');

  try {
    // 2. Chamada ao endpoint unificado
    const resp = await fetch(`${API_BASE}/unified-search?q=${encodeURIComponent(termo)}`);
    
    if (!resp.ok) {
        const errData = await resp.json().catch(()=>({})); 
        throw new Error(errData.erro || 'Erro na conex√£o com a API');
    }

    const data = await resp.json();

    // 3. Mapeamento (Backend Gemini JSON -> Frontend Dashboard)
    newsData = data.results.map(item => ({
      title: item.title,
      // O conte√∫do agora √© a s√≠ntese t√©cnica feita pela IA
      content: item.content || item.sintese_tecnica || "Sem resumo dispon√≠vel",
      url: item.url,
      source: item.source, // Ex: "G1 (+3 fontes)"
      date: item.date,
      
      // Mapeia o sentimento
      sentiment: mapSentiment(item.sentiment),
      
      // Mapeia o risco
      riskScore: (item.risco_score || 0).toFixed(1),
      riskLevel: mapRiskLevel(item.risco_classificacao),
      
      // T√©cnicas de contrapropaganda
      techniques: item.elementos_contrapropaganda || [],
      
      // Gravidade
      gravity: generateGravityDescription(mapRiskLevel(item.risco_classificacao)),
      
      mpRole: item.mp_role || 'neutro'
    }));

    updateDashboard();
    
    // Mostra controles
    document.getElementById('clearBtn').style.display = 'inline-flex';
    document.getElementById('tabsContainer').style.display = 'flex';
    
    // Mensagem de sucesso
    showStatus(`‚úÖ ${data.total_raw} men√ß√µes reduzidas a ${data.total_clusters} eventos principais analisados.`, 'ready');
    setTimeout(hideStatus, 5000);

  } catch (e) {
    console.error(e);
    showStatus('Erro: ' + e.message, 'error');
  }
}

// ============================================
// HELPERS DE MAPEAMENTO (Backend -> CSS)
// ============================================

function mapRiskLevel(level) {
    if(!level) return 'low';
    level = level.toLowerCase().trim();
    // Gemini pode retornar em PT-BR
    if(level === 'critico' || level === 'cr√≠tico') return 'critical';
    if(level === 'alto' || level === 'high') return 'high';
    if(level === 'medio' || level === 'm√©dio' || level === 'medium') return 'medium';
    return 'low';
}

function mapSentiment(s) {
    if (!s) return 'neutral';
    s = s.toLowerCase();
    if (s.includes('positive') || s.includes('positivo')) return 'positive';
    if (s.includes('negative') || s.includes('negativo')) return 'negative';
    return 'neutral';
}

// ============================================
// L√ìGICA DE DADOS DE EXEMPLO (LOCAL)
// ============================================

const demoData = [
  { 
      title: "Opera√ß√£o do MPGO desarticula esquema (Demo)", 
      content: "A√ß√£o conjunta combate fraudes.", 
      url: "#", 
      source: "O Popular", 
      date: new Date().toISOString() 
  },
  { 
      title: "Cr√≠ticas √† atua√ß√£o do promotor em caso X (Demo)", 
      content: "Advogados reclamam de excessos.", 
      url: "#", 
      source: "Blog Local", 
      date: new Date().toISOString() 
  }
];

async function loadDemoData() {
  showStatus('Carregando dados de exemplo...', 'loading');
  await new Promise(resolve => setTimeout(resolve, 500));
  // Usa a fun√ß√£o analyzeNewsItemLocal apenas para o demo
  newsData = demoData.map(analyzeNewsItemLocal);
  updateDashboard();
  document.getElementById('clearBtn').style.display = 'inline-flex';
  document.getElementById('tabsContainer').style.display = 'flex';
  showStatus('‚úÖ Dados de exemplo carregados', 'ready');
  setTimeout(hideStatus, 3000);
}

// An√°lise simples regex (apenas para o bot√£o DEMO funcionar sem gastar API)
function analyzeNewsItemLocal(item) {
    const full = (item.title + ' ' + item.content).toLowerCase();
    let sentiment = 'neutral';
    if(full.includes('cr√≠tica') || full.includes('reclama')) sentiment = 'negative';
    if(full.includes('desarticula') || full.includes('combate')) sentiment = 'positive';
    
    let riskLevel = 'low';
    let riskScore = 2;
    if(sentiment === 'negative') { riskLevel = 'high'; riskScore = 7; }
    
    return {
        ...item,
        sentiment,
        riskScore: riskScore.toFixed(1),
        riskLevel,
        techniques: [],
        gravity: generateGravityDescription(riskLevel),
        mpRole: 'neutro'
    };
}

// ============================================
// DASHBOARD & UI UTILS (MANTIDO DO ORIGINAL)
// ============================================

function generateGravityDescription(riskLevel) {
  const descriptions = {
    critical: "Exposi√ß√£o cr√≠tica √† reputa√ß√£o institucional - a√ß√£o imediata requerida",
    high: "Risco elevado com potencial de escalada - monitoramento intensivo",
    medium: "Risco moderado - acompanhamento recomendado",
    low: "Risco baixo - monitoramento rotineiro suficiente"
  };
  return descriptions[riskLevel] || descriptions['low'];
}

function showStatus(message, type = 'ready') {
  const indicator = document.getElementById('statusIndicator');
  indicator.textContent = message;
  indicator.className = `status-indicator status-${type}`;
  indicator.style.display = 'flex';
}
function hideStatus() { document.getElementById('statusIndicator').style.display = 'none'; }

function switchTab(tabName, ev) {
  currentTab = tabName;
  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
  if (ev && ev.target) ev.target.classList.add('active');
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.getElementById(tabName + 'Tab').classList.add('active');
}

function clearData() {
  newsData = [];
  historicoCompleto = [];
  document.getElementById('clearBtn').style.display = 'none';
  document.getElementById('tabsContainer').style.display = 'none';
  updateDashboard();
  showStatus('Dados limpos.', 'ready');
  setTimeout(hideStatus, 2000);
}

function updateDashboard() {
  const existentes = new Set(historicoCompleto.map(n => n.url));
  newsData.forEach(n => { if (!existentes.has(n.url)) historicoCompleto.push(n); });
  updateRiskCounters();
  updateRiskIndex();
  updateCharts();
  updateNewsTable();
  updateTechniquesTab();
}

function updateRiskCounters() {
  const counters = { critical:0, high:0, medium:0, low:0 };
  newsData.forEach(item => {
      if(counters[item.riskLevel] !== undefined) counters[item.riskLevel]++;
  });
  const container = document.getElementById('riskCounters');
  container.innerHTML = `
    <div class="card">
      <div class="card-header">
        <div class="risk-badge risk-critical">üî¥</div>
        <h3 style="margin:0;">Cr√≠tico</h3>
      </div>
      <div class="metric-value">${counters.critical}</div>
    </div>
    <div class="card">
      <div class="card-header">
        <div class="risk-badge risk-high">üü†</div>
        <h3 style="margin:0;">Alto</h3>
      </div>
      <div class="metric-value">${counters.high}</div>
    </div>
    <div class="card">
      <div class="card-header">
        <div class="risk-badge risk-medium">üü°</div>
        <h3 style="margin:0;">M√©dio</h3>
      </div>
      <div class="metric-value">${counters.medium}</div>
    </div>
    <div class="card">
      <div class="card-header">
        <div class="risk-badge risk-low">üü¢</div>
        <h3 style="margin:0;">Baixo</h3>
      </div>
      <div class="metric-value">${counters.low}</div>
    </div>
  `;
}

function updateRiskIndex() {
  if (newsData.length === 0) {
    document.getElementById('riskScore').textContent = '0.0';
    document.getElementById('riskClassification').textContent = 'Sem dados';
    document.getElementById('riskFill').style.width = '0%';
    document.getElementById('riskFill').className = 'risk-fill';
    document.getElementById('riskLabel').textContent = '0';
    return;
  }
  const avgRisk = newsData.reduce((s, i) => s + parseFloat(i.riskScore), 0) / newsData.length;
  const levelsOrder = ['low','medium','high','critical'];
  let riskLevel = 'low';
  newsData.forEach(i => {
    if (levelsOrder.indexOf(i.riskLevel) > levelsOrder.indexOf(riskLevel)) riskLevel = i.riskLevel;
  });
  document.getElementById('riskScore').textContent = avgRisk.toFixed(1);
  document.getElementById('riskClassification').textContent = riskLevel.charAt(0).toUpperCase() + riskLevel.slice(1);
  document.getElementById('riskLabel').textContent = avgRisk.toFixed(1);
  document.getElementById('riskFill').style.width = `${Math.min(avgRisk * 10, 100)}%`;
  document.getElementById('riskFill').className = `risk-fill ${riskLevel}`;
}

function updateCharts() {
  const sentimentCanvas = document.getElementById('sentimentChart');
  const riskCanvas = document.getElementById('riskChart');
  
  // Limpa canvas para evitar sobreposi√ß√£o
  const sctx = sentimentCanvas.getContext('2d');
  const rctx = riskCanvas.getContext('2d');
  sctx.clearRect(0, 0, sentimentCanvas.width, sentimentCanvas.height);
  rctx.clearRect(0, 0, riskCanvas.width, riskCanvas.height);
  
  if (newsData.length === 0) return;

  // Gr√°fico Barras Sentimento
  const sentimentData = {
    positive: newsData.filter(n => n.sentiment === 'positive').length,
    neutral: newsData.filter(n => n.sentiment === 'neutral').length,
    negative: newsData.filter(n => n.sentiment === 'negative').length
  };
  const barHeight = 40;
  const startY = 80;
  const colors = { positive: '#16a34a', neutral: '#64748b', negative: '#dc2626' };
  const labels = { positive: 'Positivo', neutral: 'Neutro', negative: 'Negativo' };

  Object.entries(sentimentData).forEach(([type, value], index) => {
    const barWidth = newsData.length ? (value / newsData.length) * 300 : 0;
    sctx.fillStyle = colors[type];
    sctx.fillRect(50, startY + index * barHeight, barWidth, barHeight - 10);
    sctx.fillStyle = 'black';
    sctx.font = 'bold 14px sans-serif';
    sctx.textAlign = 'left';
    sctx.fillText(labels[type], 10, startY + index * barHeight + 25);
    if (value > 0) {
      sctx.fillStyle = 'white';
      sctx.textAlign = 'center';
      sctx.fillText(`${value}`, 50 + barWidth/2, startY + index * barHeight + 20);
    }
  });

  // Gr√°fico Pizza Risco
  const riskData = { critical:0, high:0, medium:0, low:0 };
  newsData.forEach(item => {
      if(riskData[item.riskLevel] !== undefined) riskData[item.riskLevel]++;
  });
  let startAngle = 0;
  const riskColors = { critical: '#dc2626', high: '#ea580c', medium: '#eab308', low: '#16a34a' };
  const total = newsData.length;
  Object.entries(riskData).forEach(([level, value]) => {
    if (value > 0) {
      const sliceAngle = (value / total) * 2 * Math.PI;
      rctx.beginPath();
      rctx.moveTo(125, 125);
      rctx.arc(125, 125, 100, startAngle, startAngle + sliceAngle);
      rctx.closePath();
      rctx.fillStyle = riskColors[level];
      rctx.fill();
      startAngle += sliceAngle;
    }
  });
}

function updateNewsTable() {
  const filteredData = newsData.filter(item =>
    currentFilter === 'all' || item.sentiment === currentFilter
  );
  const tbody = document.querySelector('#newsTable tbody');
  const emptyMsg = document.getElementById('tableEmpty');
  if (filteredData.length === 0) {
    tbody.innerHTML = '';
    emptyMsg.style.display = 'block';
    return;
  }
  emptyMsg.style.display = 'none';
  tbody.innerHTML = filteredData.map(item => `
    <tr>
      <td>${item.date.slice(0,10)}</td>
      <td style="max-width: 300px;">
        <div style="font-weight:bold; color:var(--color-text-primary);">${item.title}</div>
        <div style="font-size:0.85em; color:var(--color-text-secondary); margin-top:4px; line-height:1.4;">
            ${item.content}
        </div>
      </td>
      <td><strong>${item.source}</strong></td>
      <td><span class="sentiment-badge sentiment-${item.sentiment}">${item.sentiment.toUpperCase()}</span></td>
      <td>
        <span class="risk-badge risk-${item.riskLevel}">
          <span class="risk-score">${item.riskScore}</span>
          ${item.riskLevel.toUpperCase()}
        </span>
      </td>
      <td>
        <a href="${item.url}" target="_blank" class="btn" style="padding: var(--spacing-xs) var(--spacing-md); font-size: var(--font-size-sm);">
          üìÑ Ver
        </a>
      </td>
    </tr>
  `).join('');
}

function updateTechniquesTab() {
  const allTechniques = {};
  newsData.forEach(item => {
    (item.techniques || []).forEach(tech => {
      allTechniques[tech] = (allTechniques[tech] || 0) + 1;
    });
  });
  const container = document.getElementById('techniquesList');
  if (Object.keys(allTechniques).length === 0) {
    container.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: var(--spacing-3xl); color: var(--color-text-secondary);">Nenhuma t√©cnica de propaganda detectada</div>';
    return;
  }
  container.innerHTML = Object.entries(allTechniques)
    .sort((a, b) => b[1] - a[1])
    .map(([technique, count]) => `
      <div class="technique-item">
        <div class="technique-name">${technique}</div>
        <div>üì∞ Detectada em <strong>${count}</strong> not√≠cia${count > 1 ? 's' : ''}</div>
      </div>
    `).join('');
}

function gerarResumoPeriodo() {
  alert('Funcionalidade em desenvolvimento: Exporta√ß√£o PDF/TXT do dossi√™.');
}

document.querySelectorAll('.filter-btn[data-filter]').forEach(btn => {
  btn.addEventListener('click', (ev) => {
    document.querySelectorAll('.filter-btn[data-filter]').forEach(b => b.classList.remove('active'));
    ev.target.classList.add('active');
    currentFilter = ev.target.getAttribute('data-filter');
    updateNewsTable();
  });
});
</script>

</body>
</html>
