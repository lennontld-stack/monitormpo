export default {
  // 1. O SITE (RequisiÃ§Ãµes HTTP do seu Painel)
  async fetch(request, env, ctx) {
    const url = new URL(request.url);
    const corsHeaders = {
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type',
    };

    if (request.method === 'OPTIONS') return new Response(null, { status: 204, headers: corsHeaders });

    if (url.pathname === '/unified-search') {
      const q = url.searchParams.get('q') || '';
      try {
        // Roda a busca principal
        const searchData = await runSearchRoutine(q, env);
        
        // CORREÃ‡ÃƒO: Gera o briefing se houver resultados
        // Usamos 'searchData' aqui, nÃ£o 'data'
        if (searchData.results && searchData.results.length > 0) {
           // Pega as top 5 mais relevantes para criar o resumo
           const briefing = await gerarBriefingTelegram(searchData.results.slice(0, 5), env);
           // Anexa o briefing ao JSON de resposta
           searchData.executive_briefing = briefing;
        }

        return new Response(JSON.stringify(searchData), { headers: { ...corsHeaders, 'Content-Type': 'application/json' } });
      } catch (e) {
        return new Response(JSON.stringify({ ok: false, erro: e.toString() }), { status: 500, headers: corsHeaders });
      }
    }
    return new Response(JSON.stringify({ ok: false, erro: 'Rota desconhecida' }), { status: 404 });
  },

  // 2. O ROBÃ” (Agendamento AutomÃ¡tico - CRON)
  async scheduled(event, env, ctx) {
    console.log("[CRON] Iniciando monitoramento automÃ¡tico...");
    const TERMOS_MONITORAMENTO = ["MinistÃ©rio PÃºblico de GoiÃ¡s", "GAECO GoiÃ¡s", "MPGO"];
    const termo = "MinistÃ©rio PÃºblico GoiÃ¡s"; 

    try {
      const data = await runSearchRoutine(termo, env);
      const noticias = data.results || [];

      if (noticias.length === 0) {
        console.log("[CRON] Nenhuma notÃ­cia nova relevante.");
        return;
      }

      const noticiasRelevantes = noticias.filter(n => 
        n.risco_classificacao === 'alto' || 
        n.risco_classificacao === 'critico' || 
        n.risco_classificacao === 'medio'
      );

      if (noticiasRelevantes.length === 0) return;

      const relatorioExecutivo = await gerarBriefingTelegram(noticiasRelevantes, env);

      let msg = `ðŸš¨ *MPGO MONITOR - ALERTA DE INTELIGÃŠNCIA*\n`;
      msg += `ðŸ“… ${new Date().toLocaleDateString('pt-BR')} \n\n`;
      msg += `${relatorioExecutivo}\n\n`;
      msg += `âž–âž–âž–âž–âž–âž–âž–âž–âž–âž–\n*DETALHE DOS EVENTOS:*\n\n`;

      noticiasRelevantes.slice(0, 5).forEach((n, i) => {
        const riscoEmoji = n.risco_classificacao === 'critico' ? 'ðŸ”´' : (n.risco_classificacao === 'alto' ? 'ðŸŸ ' : 'ðŸŸ¡');
        msg += `${riscoEmoji} *${n.title}*\n`;
        msg += `ðŸ”— [Acessar Fonte](${n.url})\n\n`;
      });
      msg += `ðŸ” _Acesse o painel para ver todas as ${data.total_raw} menÃ§Ãµes._`;

      await sendTelegramMessage(msg, env);
      console.log("[CRON] RelatÃ³rio enviado.");

    } catch (e) {
      console.error("[CRON] Erro fatal:", e);
    }
  }
};

// =======================================================================
// LÃ“GICA CENTRAL
// =======================================================================

async function runSearchRoutine(query, env) {
  const [google, youtube, rss] = await Promise.all([
    fetchGoogleCSE(query, env).catch(e => [{ title: "Erro Google", isError: true, error: e.message }]),
    fetchYouTube(query, env).catch(() => []),
    fetchTalkwalkerRSS(env).catch(() => [])
  ]);

  let rawItems = [...google, ...youtube, ...rss];
  if (rawItems.length > 1) rawItems = rawItems.filter(i => !i.isError);

  if (rawItems.length === 0 || (rawItems.length === 1 && rawItems[0].isError)) {
    return { ok: true, results: [], total_raw: 0, debug_msg: "Nada encontrado." };
  }

  const clusteredEvents = clusterItems(rawItems);
  const topEvents = clusteredEvents.slice(0, 10); 

  const analyzedResults = await Promise.all(
    topEvents.map(event => analyzeRiskWithChatGPT(event, env))
  );

  return {
    ok: true,
    total_raw: rawItems.length,
    total_clusters: clusteredEvents.length,
    results: analyzedResults
  };
}

// =======================================================================
// FUNÃ‡Ã•ES AUXILIARES (BUSCA)
// =======================================================================

async function fetchGoogleCSE(query, env) {
  if (!env.GOOGLE_API_KEY || !env.GOOGLE_CSE_CX) return [];
  const cleanCX = env.GOOGLE_CSE_CX.trim();
  const cleanKey = env.GOOGLE_API_KEY.trim();
  const url = `https://www.googleapis.com/customsearch/v1?q=${encodeURIComponent(query)}&cx=${cleanCX}&key=${cleanKey}&num=10&gl=br&hl=pt&dateRestrict=d2&sort=date`;
  const resp = await fetch(url);
  const data = await resp.json();
  if (data.error) throw new Error(data.error.message);
  if (!data.items) return [];

  const currentYear = new Date().getFullYear();
  const oldYears = [(currentYear - 1).toString(), (currentYear - 2).toString(), '2023', '2024'];
  const timeLimit = new Date(Date.now() - 48 * 60 * 60 * 1000).getTime();

  return data.items.map(item => {
      let realDate = null;
      if (item.pagemap?.metatags?.length > 0) {
        const t = item.pagemap.metatags[0];
        const d = t['article:published_time'] || t['og:published_time'] || t['date'] || t['pubdate'];
        if (d) realDate = new Date(d);
      }
      if (!realDate || isNaN(realDate.getTime())) realDate = new Date();

      return {
        title: item.title, link: item.link, url: item.link, source: item.displayLink || 'Google News',
        date: realDate.toISOString(), snippet: item.snippet, type: 'news', originalTimestamp: realDate.getTime()
      };
    }).filter(item => {
      const txt = (item.title + ' ' + item.snippet).toLowerCase();
      if (oldYears.some(y => txt.includes(y))) return false;
      if (item.originalTimestamp < timeLimit) return false;
      return true;
    });
}

async function fetchYouTube(query, env) {
  if (!env.YOUTUBE_API_KEY) return [];
  const yesterday = new Date(Date.now() - 48 * 60 * 60 * 1000).toISOString();
  const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&key=${env.YOUTUBE_API_KEY}&type=video&maxResults=5&relevanceLanguage=pt&publishedAfter=${yesterday}`;
  const resp = await fetch(url);
  const data = await resp.json();
  if (!data.items) return [];
  return data.items.map(i => ({
    title: i.snippet.title, link: `https://youtu.be/${i.id.videoId}`, url: `https://youtu.be/${i.id.videoId}`,
    source: 'YouTube', date: i.snippet.publishedAt, snippet: i.snippet.description, type: 'video'
  }));
}

async function fetchTalkwalkerRSS(env) {
  const FEED_URL = 'https://alerts.talkwalker.com/alerts/rss/INTV3F27HNZBMIXMI3PCZBF7RRQY6BTVLUDLUOQ223BDP2WHYQ4D46LMZIECUZBXUCNVFMELHWEKK83';
  const resp = await fetch(FEED_URL);
  const xml = await resp.text();
  const items = [];
  const itemRegex = /<item>([\s\S]*?)<\/item>/gi;
  let match;
  const cutoff = Date.now() - 48 * 60 * 60 * 1000;
  while ((match = itemRegex.exec(xml)) !== null) {
    const block = match[1];
    const title = (block.match(/<title>([\s\S]*?)<\/title>/)?.[1] || '').replace('<![CDATA[','').replace(']]>','').trim();
    const link = (block.match(/<link>(.*?)<\/link>/)?.[1] || '').trim();
    const dateStr = (block.match(/<pubDate>(.*?)<\/pubDate>/)?.[1] || '');
    const dateObj = dateStr ? new Date(dateStr) : new Date();
    if (dateObj.getTime() > cutoff && title) {
      items.push({ title, link, url: link, source: 'Talkwalker', date: dateObj.toISOString(), snippet: title, type: 'rss' });
    }
  }
  return items;
}

function clusterItems(items) {
  const clusters = [];
  items.forEach(item => {
    if(item.isError) return;
    const found = clusters.find(c => similarity(c.mainTitle, item.title) > 0.4);
    if(found) { 
      found.sources.push(item);
      if(item.type === 'news' || new Date(item.date) > new Date(found.date)) {
         found.mainTitle = item.title; found.link = item.link; found.url = item.link; found.content = item.snippet; found.date = item.date;
      }
    } else {
      clusters.push({ mainTitle: item.title, link: item.link, url: item.link, date: item.date, source: item.source, content: item.snippet || item.title, sources: [item] });
    }
  });
  return clusters;
}

function similarity(s1, s2) {
  if (!s1 || !s2) return 0;
  const w1 = s1.toLowerCase().split(/\W+/);
  const w2 = s2.toLowerCase().split(/\W+/);
  const intersection = w1.filter(x => w2.includes(x) && x.length > 3);
  return intersection.length / ((w1.length + w2.length) / 2);
}

// =======================================================================
// INTELIGÃŠNCIA ARTIFICIAL (ChatGPT)
// =======================================================================

async function analyzeRiskWithChatGPT(eventItem, env) {
  const baseObject = { ...eventItem, title: eventItem.mainTitle, url: eventItem.link, content: eventItem.content || "Sem resumo", risco_score: 50, risco_classificacao: 'medio', sentiment: 'neutral' };
  if (!env.OPENAI_API_KEY) return { ...baseObject, content: "âš ï¸ Sem Chave OpenAI" };

  try {
    const resp = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${env.OPENAI_API_KEY}` },
      body: JSON.stringify({
        model: "gpt-4o-mini",
        response_format: { type: "json_object" },
        messages: [
          { role: "system", content: "Analista de risco MPGO. Retorne JSON." },
          { role: "user", content: `Analise: "${eventItem.mainTitle}". Resumo: ${eventItem.content}. JSON: { "sintese_tecnica": "1 frase pt-br", "risco_classificacao": "baixo|medio|alto|critico", "risco_score": 0-100, "sentimento": "positive|neutral|negative" }` }
        ],
        temperature: 0.2
      })
    });
    const data = await resp.json();
    const res = JSON.parse(data.choices[0].message.content);
    return { ...baseObject, ...res, url: eventItem.link, title: eventItem.mainTitle, content: res.sintese_tecnica, source: `${eventItem.source} (+${eventItem.sources.length-1})` };
  } catch (e) {
    return baseObject;
  }
}

async function gerarBriefingTelegram(noticias, env) {
  if (!env.OPENAI_API_KEY) return "âš ï¸ *Resumo AutomÃ¡tico IndisponÃ­vel (Sem Chave)*";
  const listaTexto = noticias.map(n => `- ${n.title} (Risco: ${n.risco_classificacao})`).join('\n');
  try {
    const resp = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${env.OPENAI_API_KEY}` },
      body: JSON.stringify({
        model: "gpt-4o-mini",
        messages: [
          { role: "system", content: "VocÃª Ã© um Assessor de ComunicaÃ§Ã£o SÃªnior do MinistÃ©rio PÃºblico. Escreva um briefing executivo de 1 parÃ¡grafo para o Procurador-Geral." },
          { role: "user", content: `Com base nestas notÃ­cias:\n${listaTexto}\n\nEscreva um resumo executivo. Comece com "ðŸ“Š *CenÃ¡rio Atual:*". Seja breve e direto.` }
        ],
        temperature: 0.5
      })
    });
    const data = await resp.json();
    return data.choices[0].message.content;
  } catch (e) {
    return null;
  }
}

async function sendTelegramMessage(text, env) {
  if (!env.TELEGRAM_BOT_TOKEN || !env.TELEGRAM_CHAT_ID) return;
  const url = `https://api.telegram.org/bot${env.TELEGRAM_BOT_TOKEN}/sendMessage`;
  await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      chat_id: env.TELEGRAM_CHAT_ID,
      text: text,
      parse_mode: 'Markdown',
      disable_web_page_preview: true
    })
  });
}
