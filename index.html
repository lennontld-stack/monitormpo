<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MPGO Monitor - An√°lise de Reputa√ß√£o Executiva</title>
    <style>
        :root {
            --color-critical: #dc2626;
            --color-high: #ea580c;
            --color-medium: #eab308;
            --color-low: #16a34a;
            --color-success: #059669;
            --color-warning: #d97706;
            --color-danger: #dc2626;
            --color-primary: #1e40af;
            --color-secondary: #64748b;
            --color-background: #f8fafc;
            --color-surface: #ffffff;
            --color-surface-2: #f1f5f9;
            --color-text-primary: #0f172a;
            --color-text-secondary: #475569;
            --color-border: #e2e8f0;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --font-size-sm: 0.875rem;
            --font-size-base: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem;
            --font-size-2xl: 1.5rem;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;
            --spacing-xs: 0.5rem;
            --spacing-sm: 0.75rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.25rem;
            --spacing-xl: 1.5rem;
            --spacing-2xl: 2rem;
            --spacing-3xl: 3rem;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --border-radius: 0.5rem;
            --border-radius-lg: 0.75rem;
            --border-radius-xl: 1rem;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-family);
            background: var(--color-background);
            color: var(--color-text-primary);
            line-height: 1.6;
            font-size: var(--font-size-base);
        }
        .header {
            background: linear-gradient(135deg, var(--color-primary) 0%, #1d4ed8 100%);
            color: white;
            padding: var(--spacing-2xl) var(--spacing-3xl);
            box-shadow: var(--shadow-xl);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: var(--spacing-xl);
        }
        .logo {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
        }
        .logo-icon {
            width: 48px;
            height: 48px;
            background: rgba(255,255,255,0.2);
            border-radius: var(--border-radius-xl);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-xl);
            font-weight: bold;
        }
        .header-title { font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); }
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--spacing-xl);
        }
        .input-section {
            background: var(--color-surface);
            border-radius: var(--border-radius-xl);
            padding: var(--spacing-2xl);
            margin-bottom: var(--spacing-2xl);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--color-border);
        }
        .input-group { display: flex; flex-direction: column; gap: var(--spacing-lg); }
        @media (min-width: 768px) {
            .input-group { flex-direction: row; align-items: end; }
            .input-group .input-field { flex: 1; }
        }
        .input-field { flex: 1; }
        .input-field label {
            display: block;
            margin-bottom: var(--spacing-sm);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            font-size: var(--font-size-sm);
        }
        .input-field input {
            width: 100%;
            padding: var(--spacing-md) var(--spacing-lg);
            border: 2px solid var(--color-border);
            border-radius: var(--border-radius-lg);
            font-size: var(--font-size-base);
            transition: all 0.2s ease;
            background: var(--color-surface);
        }
        .input-field input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }
        .btn {
            padding: var(--spacing-lg) var(--spacing-2xl);
            border: none;
            border-radius: var(--border-radius-lg);
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-semibold);
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            text-decoration: none;
            min-height: 52px;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--color-primary) 0%, #1d4ed8 100%);
            color: white;
            box-shadow: var(--shadow-lg);
        }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: var(--shadow-xl); }
        .btn-secondary {
            background: var(--color-surface-2);
            color: var(--color-text-primary);
            border: 2px solid var(--color-border);
        }
        .btn-secondary:hover {
            background: var(--color-surface);
            border-color: var(--color-primary);
            color: var(--color-primary);
        }
        .btn-danger { background: var(--color-danger); color: white; }
        .btn-group { display: flex; gap: var(--spacing-md); flex-wrap: wrap; }
        .status-indicator {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--border-radius);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            margin-top: var(--spacing-md);
        }
        .status-ready { background: rgba(22, 163, 74, 0.1); color: var(--color-success); }
        .status-loading { background: rgba(245, 158, 11, 0.1); color: var(--color-warning); }
        .status-error { background: rgba(220, 38, 38, 0.1); color: var(--color-danger); }
        .tabs {
            display: none;
            background: var(--color-surface);
            border-radius: var(--border-radius-xl) var(--border-radius-xl) 0 0;
            box-shadow: var(--shadow-md);
            margin-bottom: 0;
            overflow: hidden;
        }
        .tab {
            flex: 1;
            padding: var(--spacing-lg) var(--spacing-xl);
            background: none;
            border: none;
            font-weight: var(--font-weight-semibold);
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--color-text-secondary);
        }
        .tab.active { background: var(--color-primary); color: white; }
        .tab-content {
            background: var(--color-surface);
            border-radius: 0 0 var(--border-radius-xl) var(--border-radius-xl);
            padding: var(--spacing-2xl);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--color-border);
            border-top: none;
            display: none;
        }
        .tab-content.active { display: block; }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--spacing-xl);
            margin-bottom: var(--spacing-2xl);
        }
        .card {
            background: var(--color-surface);
            border-radius: var(--border-radius-xl);
            padding: var(--spacing-xl);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--color-border);
        }
        .card-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }
        .risk-badge {
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--border-radius);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-bold);
            text-transform: uppercase;
        }
        .risk-critical { background: rgba(220, 38, 38, 0.1); color: var(--color-critical); }
        .risk-high { background: rgba(234, 88, 12, 0.1); color: var(--color-high); }
        .risk-medium { background: rgba(234, 179, 8, 0.1); color: var(--color-medium); }
        .risk-low { background: rgba(22, 163, 74, 0.1); color: var(--color-low); }
        .metric-value {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-text-primary);
        }
        .risk-index-container { text-align: center; }
        .risk-gauge {
            width: 100%; height: 20px;
            background: var(--color-surface-2);
            border-radius: 10px;
            overflow: hidden;
            margin: var(--spacing-lg) 0;
            position: relative;
        }
        .risk-fill { height: 100%; transition: width 1s ease; position: relative; }
        .risk-fill.critical { background: linear-gradient(90deg, var(--color-critical), #b91c1c); }
        .risk-fill.high { background: linear-gradient(90deg, var(--color-high), #c2410c); }
        .risk-fill.medium { background: linear-gradient(90deg, var(--color-medium), #ca8a04); }
        .risk-fill.low { background: linear-gradient(90deg, var(--color-low), #15803d); }
        .risk-label {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-lg);
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        .chart-container {
            height: 300px;
            position: relative;
            background: var(--color-surface-2);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-xl);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: var(--spacing-md);
        }
        .sentiment-chart, .risk-chart { width: 100%; height: 250px; }
        .filters {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
            flex-wrap: wrap;
            align-items: center;
        }
        .filter-btn {
            padding: var(--spacing-sm) var(--spacing-lg);
            background: var(--color-surface-2);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: var(--font-size-sm);
        }
        .filter-btn.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }
        .table-container {
            overflow-x: auto;
            background: var(--color-surface);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
        }
        table { width: 100%; border-collapse: collapse; }
        th, td {
            padding: var(--spacing-lg);
            text-align: left;
            border-bottom: 1px solid var(--color-border);
        }
        th {
            background: var(--color-surface-2);
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-sm);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--color-text-secondary);
        }
        tr:hover { background: rgba(30, 64, 175, 0.02); }
        .sentiment-badge {
            padding: var(--spacing-xs) var(--spacing-md);
            border-radius: var(--border-radius);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
        }
        .sentiment-positive { background: rgba(22, 163, 74, 0.1); color: var(--color-success); }
        .sentiment-neutral { background: rgba(100, 116, 139, 0.1); color: var(--color-secondary); }
        .sentiment-negative { background: rgba(220, 38, 38, 0.1); color: var(--color-danger); }
        .risk-score { font-weight: var(--font-weight-bold); font-size: var(--font-size-lg); }
        .techniques-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--spacing-lg);
        }
        .technique-item {
            background: var(--color-surface-2);
            border-left: 4px solid var(--color-warning);
            padding: var(--spacing-lg);
            border-radius: 0 var(--border-radius-lg) var(--border-radius-lg) 0;
        }
        .technique-name {
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-lg);
            margin-bottom: var(--spacing-sm);
        }
        @media (max-width: 768px) {
            .main-container { padding: var(--spacing-md); }
            .header-content { flex-direction: column; text-align: center; gap: var(--spacing-lg); }
            .dashboard-grid { grid-template-columns: 1fr; }
            .btn-group { flex-direction: column; }
        }
    </style>
</head>
<body>
<header class="header">
    <div class="header-content">
        <div class="logo">
            <div class="logo-icon">üö®</div>
            <div>
                <div class="header-title">MPGO Monitor</div>
                <div style="font-size: var(--font-size-sm); opacity: 0.9;">An√°lise Executiva de Reputa√ß√£o</div>
            </div>
        </div>
    </div>
</header>

<main class="main-container">
    <section class="input-section">
        <div class="input-group">
            <div class="input-field">
                <label for="feedUrl">URL do Feed RSS (Talkwalker)</label>
                <input type="url" id="feedUrl" placeholder="https://alerts.talkwalker.com/alerts/rss/...">
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="loadAndAnalyzeFeed()">üì° Carregar Feed (via Worker)</button>
                <button class="btn btn-secondary" onclick="loadDemoData()">üéØ Dados de Exemplo (local)</button>
                <button class="btn btn-danger" onclick="clearData()" style="display: none;" id="clearBtn">üóëÔ∏è Limpar</button>
            </div>
        </div>
        <div id="statusIndicator" class="status-indicator" style="display: none;"></div>
    </section>

    <div class="tabs" id="tabsContainer">
        <button class="tab active" onclick="switchTab('dashboard', event)">Dashboard</button>
        <button class="tab" onclick="switchTab('techniques', event)">T√©cnicas Detectadas</button>
    </div>

    <div id="dashboardTab" class="tab-content active">
        <div class="dashboard-grid" id="riskCounters"></div>

        <div class="dashboard-grid">
            <div class="card" style="grid-column: span 2;">
                <div class="card-header">
                    <div class="risk-badge risk-critical">üìä</div>
                    <div>
                        <h3 style="margin: 0; font-size: var(--font-size-lg);">√çndice Geral de Risco</h3>
                        <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">M√©dia ponderada das √∫ltimas 24h</div>
                    </div>
                </div>
                <div class="risk-index-container">
                    <div class="risk-gauge">
                        <div class="risk-fill" id="riskFill" style="width: 0%;">
                            <div class="risk-label" id="riskLabel">0</div>
                        </div>
                    </div>
                    <div id="riskScore" class="metric-value">0.0</div>
                    <div id="riskClassification" style="font-size: var(--font-size-sm); opacity: 0.7;">Sem dados</div>
                </div>
            </div>
            <div class="card">
                <h3 style="margin-bottom: var(--spacing-lg);">Distribui√ß√£o de Sentimento</h3>
                <div class="chart-container">
                    <canvas id="sentimentChart" class="sentiment-chart"></canvas>
                </div>
            </div>
            <div class="card">
                <h3 style="margin-bottom: var(--spacing-lg);">Distribui√ß√£o de Risco</h3>
                <div class="chart-container">
                    <canvas id="riskChart" class="risk-chart"></canvas>
                </div>
            </div>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-xl); flex-wrap: wrap; gap: var(--spacing-md);">
                <h3 style="margin: 0;">√öltimas Not√≠cias Analisadas</h3>
                <div class="filters">
                    <input type="date" id="dataIni">
                    <input type="date" id="dataFim">
                    <button class="filter-btn active" data-filter="all">Todas</button>
                    <button class="filter-btn" data-filter="positive">Positivo</button>
                    <button class="filter-btn" data-filter="neutral">Neutro</button>
                    <button class="filter-btn" data-filter="negative">Negativo</button>
                    <button class="filter-btn" onclick="gerarResumoPeriodo()">Resumo / TXT</button>
                </div>
            </div>
            <div class="table-container">
                <table id="newsTable">
                    <thead>
                    <tr>
                        <th>Data</th>
                        <th>T√≠tulo</th>
                        <th>Fonte</th>
                        <th>Sentimento</th>
                        <th>Risco</th>
                        <th>A√ß√µes</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div style="text-align: center; padding: var(--spacing-xl); color: var(--color-text-secondary);">
                <span id="tableEmpty">Clique em "Dados de Exemplo" ou informe um RSS para come√ßar</span>
            </div>
        </div>
    </div>

    <div id="techniquesTab" class="tab-content">
        <div class="techniques-grid" id="techniquesList"></div>
    </div>
</main>

<script>
    const API_BASE = 'https://monitormpgo.lennontld.workers.dev';

    let newsData = [];
    let historicoCompleto = [];
    let currentTab = 'dashboard';
    let currentFilter = 'all';

    const demoData = [
        {
            title: "MP-GO emite de gra√ßa certid√µes eletr√¥nicas sobre processos extrajudiciais",
            source: "G1 Goi√°s",
            date: "2020-01-05",
            url: "https://g1.globo.com/go/goias/noticia/2020/01/05/mp-go-emite-de-graca-certidoes-eletronicas-sobre-processos-extrajudiciais.ghtml",
            content: "MP-GO passa a emitir de gra√ßa certid√µes eletr√¥nicas sobre processos extrajudiciais, facilitando acesso do cidad√£o √† informa√ß√£o."
        },
        {
            title: "Servidores usavam certificados falsos para conseguir gratifica√ß√µes; MP investiga esquema",
            source: "G1 Goi√°s",
            date: "2025-02-02",
            url: "https://g1.globo.com/go/goias/noticia/2025/02/03/servidores-usavam-certificados-falsos-para-conseguir-gratificacoes-nos-salarios.ghtml",
            content: "Minist√©rio P√∫blico de Goi√°s investiga esquema de certificados falsos usados por servidores para aumentar gratifica√ß√µes salariais."
        },
        {
            title: "MP-GO desiste de briga judicial e n√£o vai mais exigir c√¢meras nas fardas da PM",
            source: "Jornal Op√ß√£o",
            date: "2025-06-10",
            url: "https://www.jornalopcao.com.br/justica/mp-go-desiste-de-briga-judicial-e-nao-vai-mais-exigir-cameras-em-fardas-da-pm-758316/",
            content: "Decis√£o do MP-GO de desistir de a√ß√£o que pedia uso obrigat√≥rio de c√¢meras em fardas da PM gera cr√≠ticas de entidades de direitos humanos."
        },
        {
            title: "MPGO lan√ßa ferramenta digital para materializar evid√™ncias em investiga√ß√µes",
            source: "Portal MPGO",
            date: "2023-08-20",
            url: "https://www.mpgo.mp.br/portal/pagina/medi-materializador-de-evidencias-digitais-e-informaticas",
            content: "Ferramenta MEDI permite ao Minist√©rio P√∫blico de Goi√°s coletar e preservar evid√™ncias digitais com mais seguran√ßa e rastreabilidade."
        }
    ];

    const propagandaTechniques = {
        'falsa dicotomia': ['ou ', 'tudo ou nada', 'preto no branco', 'extremismo'],
        'apelo emocional': ['indigna√ß√£o', 'medo', 'raiva', 'horror', 'tristeza', 'chocante'],
        'generaliza√ß√£o': ['todos', 'ningu√©m', 'sempre', 'nunca', 'todos os', 'nenhum'],
        'desinforma√ß√£o': ['falso', 'mentira', 'fake', 'inventado', 'manipulado'],
        'estere√≥tipo': ['corrupto', 'bandidos', 'inimigo', 'vermelho', 'elite'],
        'omiss√£o contexto': ['sem explicar', 'sem mencionar', 'ignorando que', 'escondendo'],
        'ad hominem': ['incompetente', 'corrupto', 'ladr√£o', 'idiota', 'burro'],
        'fonte n√£o confi√°vel': ['segundo blogueiro', 'fonte an√¥nima', 'dizem que']
    };

    const sentimentLexicon = {
        positive: ['excelente', '√≥timo', 'sucesso', 'eficaz', 'importante', 'reconhecido', 'eficiente', 'recupera', 'devolu√ß√£o', 'gratuito', 'facilitando'],
        negative: ['fracasso', 'corrup√ß√£o', 'incompet√™ncia', 'esc√¢ndalo', 'den√∫ncia', 'investiga√ß√£o', 'cr√≠tica', 'estupro', 'suspensa', 'esquema'],
        neutral: ['informou', 'disse', 'declarou', 'realizou', 'participou']
    };

    function analyzeNewsItem(item) {
  const full = (item.title + ' ' + item.content).toLowerCase();

  const mpAgente = [
    'mp-go investiga',
    'mpgo investiga',
    'minist√©rio p√∫blico de goi√°s investiga',
    'mp-go denuncia',
    'mpgo denuncia',
    'ofereceu den√∫ncia',
    'oferece den√∫ncia',
    'ofereceu denuncia',
    'oferece denuncia',
    'ajuizou a√ß√£o',
    'ajuizou acao',
    'prop√¥s a√ß√£o',
    'prop√¥s acao',
    'prop√µe a√ß√£o',
    'prop√µe acao',
    'deflagrou opera√ß√£o',
    'deflagra opera√ß√£o',
    'deflagrou operacao',
    'deflagra operacao',
    'realizou opera√ß√£o',
    'realiza opera√ß√£o',
    'realizou operacao',
    'realiza operacao',
    'mp-go recupera',
    'mpgo recupera',
    'mp-go emite',
    'mp-go lan√ßa',
    'mpgo lan√ßa'
  ].some(p => full.includes(p));

  const mpAlvo =
    full.includes('mp-go √© criticado') ||
    full.includes('mp-go √© acusado') ||
    full.includes('cr√≠ticas ao mp-go') ||
    full.includes('criticas ao mp-go') ||
    full.includes('criticou o mp-go') ||
    full.includes('criticou o minist√©rio p√∫blico de goi√°s') ||
    full.includes('residente jur√≠dico critica o mpgo') ||
    full.includes('residente juridico critica o mpgo') ||
    full.includes('atraso no pagamento de bolsas do mpgo');

  let sentimentoScore = 0;
  Object.keys(sentimentLexicon).forEach(tipo => {
    sentimentLexicon[tipo].forEach(palavra => {
      if (full.includes(palavra)) {
        if (tipo === 'negative') sentimentoScore -= 1;
        if (tipo === 'positive') sentimentoScore += 1;
      }
    });
  });

  if (mpAgente) {
    if (sentimentoScore < 0) {
      sentimentoScore = 0;
    }
    if (sentimentoScore >= 0) {
      sentimentoScore = 3;
    }
  }

  let sentimento = 'neutral';
  if (sentimentoScore > 0.5) sentimento = 'positive';
  else if (sentimentoScore < -0.5) sentimento = 'negative';

  const detectedTechniques = [];
  Object.entries(propagandaTechniques).forEach(([technique, keywords]) => {
    const matches = keywords.filter(keyword => full.includes(keyword)).length;
    if (matches > 0) {
      const name = technique.replace(/\b\w/g, c => c.toUpperCase());
      detectedTechniques.push(name);
    }
  });

  // NOVA L√ìGICA DE RISCO
  let riskScore = 0;

  const citaMP =
    full.includes('mpgo') ||
    full.includes('mp-go') ||
    full.includes('minist√©rio p√∫blico de goi√°s') ||
    full.includes('minist√©rio p√∫blico de goias');

  if (sentimento === 'negative') riskScore += 3;
  if (sentimento === 'positive') riskScore -= 2;

  riskScore += detectedTechniques.length * 1.5;

  if (citaMP) riskScore += 2;

  if (mpAgente && !mpAlvo) {
    riskScore -= 4;
  } else if (mpAlvo && !mpAgente) {
    riskScore += 3;
  }

  riskScore = Math.max(0, Math.min(10, riskScore));

  let riskLevel;
  if (riskScore >= 8) riskLevel = 'critical';
  else if (riskScore >= 6) riskLevel = 'high';
  else if (riskScore >= 3) riskLevel = 'medium';
  else riskLevel = 'low';

  return {
    ...item,
    sentiment: sentimento,
    riskScore: riskScore.toFixed(1),
    riskLevel,
    techniques: detectedTechniques,
    gravity: generateGravityDescription(riskLevel, detectedTechniques),
    mpRole: mpAgente ? 'autor' : (mpAlvo ? 'alvo' : 'nenhum'),
    mpAgente,
    mpAlvo
  };
}


    function generateGravityDescription(riskLevel, techniques) {
        const descriptions = {
            critical: "Exposi√ß√£o cr√≠tica √† reputa√ß√£o institucional - a√ß√£o imediata requerida",
            high: "Risco elevado com potencial de escalada - monitoramento intensivo",
            medium: "Risco moderado - acompanhamento recomendado",
            low: "Risco baixo - monitoramento rotineiro suficiente"
        };
        return descriptions[riskLevel];
    }

    function showStatus(message, type = 'ready') {
        const indicator = document.getElementById('statusIndicator');
        indicator.textContent = message;
        indicator.className = `status-indicator status-${type}`;
        indicator.style.display = 'flex';
    }
    function hideStatus() { document.getElementById('statusIndicator').style.display = 'none'; }

    function switchTab(tabName, ev) {
        currentTab = tabName;
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        if (ev && ev.target) ev.target.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById(tabName + 'Tab').classList.add('active');
    }

    async function loadDemoData() {
        showStatus('Carregando dados de exemplo...', 'loading');
        await new Promise(resolve => setTimeout(resolve, 500));
        newsData = demoData.map(analyzeNewsItem);
        updateDashboard();
        document.getElementById('clearBtn').style.display = 'inline-flex';
        document.getElementById('tabsContainer').style.display = 'flex';
        showStatus('‚úÖ An√°lise conclu√≠da com dados de exemplo', 'ready');
        setTimeout(hideStatus, 3000);
    }

    async function loadAndAnalyzeFeed() {
        const url = document.getElementById('feedUrl').value.trim();
        if (!url) {
            alert('Informe a URL do RSS (Talkwalker)');
            return;
        }

        showStatus('Carregando e analisando feed...', 'loading');

        try {
            const resp = await fetch(`${API_BASE}?feed=${encodeURIComponent(url)}`);
            const dados = await resp.json();

            if (!dados.ok || !dados.itens) {
                console.error('Resposta inv√°lida da API MPGO:', dados);
                alert('Erro ao carregar feed.');
                showStatus('Erro ao carregar feed.', 'error');
                return;
            }

            newsData = dados.itens.map(raw => analyzeNewsItem({
                title: raw.titulo,
                content: raw.resumo || '',
                url: raw.link,
                source: (new URL(raw.link)).hostname.replace('www.', ''),
                date: new Date().toISOString().slice(0, 10)
            }));

            updateDashboard();
            document.getElementById('clearBtn').style.display = 'inline-flex';
            document.getElementById('tabsContainer').style.display = 'flex';
            showStatus('‚úÖ An√°lise conclu√≠da com RSS real', 'ready');
            setTimeout(hideStatus, 3000);
        } catch (e) {
            console.error('Erro ao buscar/analisar feed:', e);
            alert('Falha ao chamar o Worker.');
            showStatus('Erro de rede ao chamar o Worker.', 'error');
        }
    }

    function clearData() {
        newsData = [];
        historicoCompleto = [];
        document.getElementById('clearBtn').style.display = 'none';
        document.getElementById('tabsContainer').style.display = 'none';
        updateDashboard();
        showStatus('Dados limpos.', 'ready');
        setTimeout(hideStatus, 2000);
    }

    function updateDashboard() {
        const existentes = new Set(historicoCompleto.map(n => n.url));
        newsData.forEach(n => { if (!existentes.has(n.url)) historicoCompleto.push(n); });
        updateRiskCounters();
        updateRiskIndex();
        updateCharts();
        updateNewsTable();
        updateTechniquesTab();
    }

    function updateRiskCounters() {
        const counters = { critical:0, high:0, medium:0, low:0 };
        newsData.forEach(item => counters[item.riskLevel]++);
        const container = document.getElementById('riskCounters');
        container.innerHTML = `
            <div class="card">
                <div class="card-header">
                    <div class="risk-badge risk-critical">üî¥</div>
                    <h3 style="margin:0;">Cr√≠tico</h3>
                </div>
                <div class="metric-value">${counters.critical}</div>
            </div>
            <div class="card">
                <div class="card-header">
                    <div class="risk-badge risk-high">üü†</div>
                    <h3 style="margin:0;">Alto</h3>
                </div>
                <div class="metric-value">${counters.high}</div>
            </div>
            <div class="card">
                <div class="card-header">
                    <div class="risk-badge risk-medium">üü°</div>
                    <h3 style="margin:0;">M√©dio</h3>
                </div>
                <div class="metric-value">${counters.medium}</div>
            </div>
            <div class="card">
                <div class="card-header">
                    <div class="risk-badge risk-low">üü¢</div>
                    <h3 style="margin:0;">Baixo</h3>
                </div>
                <div class="metric-value">${counters.low}</div>
            </div>
        `;
    }

    function updateRiskIndex() {
        if (newsData.length === 0) {
            document.getElementById('riskScore').textContent = '0.0';
            document.getElementById('riskClassification').textContent = 'Sem dados';
            document.getElementById('riskFill').style.width = '0%';
            document.getElementById('riskFill').className = 'risk-fill';
            document.getElementById('riskLabel').textContent = '0';
            return;
        }
        const avgRisk = newsData.reduce((s, i) => s + parseFloat(i.riskScore), 0) / newsData.length;
        const levelsOrder = ['low','medium','high','critical'];
        let riskLevel = 'low';
        newsData.forEach(i => {
            if (levelsOrder.indexOf(i.riskLevel) > levelsOrder.indexOf(riskLevel)) riskLevel = i.riskLevel;
        });
        document.getElementById('riskScore').textContent = avgRisk.toFixed(1);
        document.getElementById('riskClassification').textContent = riskLevel.charAt(0).toUpperCase() + riskLevel.slice(1);
        document.getElementById('riskLabel').textContent = avgRisk.toFixed(1);
        document.getElementById('riskFill').style.width = `${avgRisk * 10}%`;
        document.getElementById('riskFill').className = `risk-fill ${riskLevel}`;
    }

    function updateCharts() {
        const sentimentCanvas = document.getElementById('sentimentChart');
        const riskCanvas = document.getElementById('riskChart');
        const sctx = sentimentCanvas.getContext('2d');
        const rctx = riskCanvas.getContext('2d');
        sctx.clearRect(0, 0, sentimentCanvas.width, sentimentCanvas.height);
        rctx.clearRect(0, 0, riskCanvas.width, riskCanvas.height);
        if (newsData.length === 0) return;

        const sentimentData = {
            positive: newsData.filter(n => n.sentiment === 'positive').length,
            neutral: newsData.filter(n => n.sentiment === 'neutral').length,
            negative: newsData.filter(n => n.sentiment === 'negative').length
        };
        const barHeight = 40;
        const startY = 80;
        const colors = { positive: '#16a34a', neutral: '#64748b', negative: '#dc2626' };
        const labels = { positive: 'Positivo', neutral: 'Neutro', negative: 'Negativo' };

        Object.entries(sentimentData).forEach(([type, value], index) => {
            const barWidth = newsData.length ? (value / newsData.length) * 300 : 0;
            sctx.fillStyle = colors[type];
            sctx.fillRect(50, startY + index * barHeight, barWidth, barHeight - 10);
            sctx.fillStyle = 'black';
            sctx.font = 'bold 14px sans-serif';
            sctx.textAlign = 'left';
            sctx.fillText(labels[type], 10, startY + index * barHeight + 25);
            if (value > 0) {
                sctx.fillStyle = 'white';
                sctx.textAlign = 'center';
                sctx.fillText(`${value}`, 50 + barWidth/2, startY + index * barHeight + 20);
            }
        });

        const riskData = { critical:0, high:0, medium:0, low:0 };
        newsData.forEach(item => riskData[item.riskLevel]++);
        let startAngle = 0;
        const riskColors = { critical: '#dc2626', high: '#ea580c', medium: '#eab308', low: '#16a34a' };
        const total = newsData.length;
        Object.entries(riskData).forEach(([level, value]) => {
            if (value > 0) {
                const sliceAngle = (value / total) * 2 * Math.PI;
                rctx.beginPath();
                rctx.moveTo(125, 125);
                rctx.arc(125, 125, 100, startAngle, startAngle + sliceAngle);
                rctx.closePath();
                rctx.fillStyle = riskColors[level];
                rctx.fill();
                startAngle += sliceAngle;
            }
        });
    }

    function updateNewsTable() {
        const filteredData = newsData.filter(item =>
            currentFilter === 'all' || item.sentiment === currentFilter
        );
        const tbody = document.querySelector('#newsTable tbody');
        const emptyMsg = document.getElementById('tableEmpty');
        if (filteredData.length === 0) {
            tbody.innerHTML = '';
            emptyMsg.style.display = 'block';
            return;
        }
        emptyMsg.style.display = 'none';
        tbody.innerHTML = filteredData.map(item => `
            <tr>
                <td>${item.date}</td>
                <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    ${item.title}
                </td>
                <td><strong>${item.source}</strong></td>
                <td><span class="sentiment-badge sentiment-${item.sentiment}">${item.sentiment.toUpperCase()}</span></td>
                <td>
                    <span class="risk-badge risk-${item.riskLevel}">
                        <span class="risk-score">${item.riskScore}</span>
                        ${item.riskLevel.charAt(0).toUpperCase() + item.riskLevel.slice(1)}
                    </span>
                </td>
                <td>
                    <a href="${item.url}" target="_blank" class="btn" style="padding: var(--spacing-xs) var(--spacing-md); font-size: var(--font-size-sm);">
                        üìÑ Ver
                    </a>
                </td>
            </tr>
        `).join('');
    }

    function updateTechniquesTab() {
        const allTechniques = {};
        newsData.forEach(item => {
            (item.techniques || []).forEach(tech => {
                allTechniques[tech] = (allTechniques[tech] || 0) + 1;
            });
        });
        const container = document.getElementById('techniquesList');
        if (Object.keys(allTechniques).length === 0) {
            container.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: var(--spacing-3xl); color: var(--color-text-secondary);">Nenhuma t√©cnica de propaganda detectada</div>';
            return;
        }
        container.innerHTML = Object.entries(allTechniques)
            .sort((a, b) => b[1] - a[1])
            .map(([technique, count]) => `
                <div class="technique-item">
                    <div class="technique-name">${technique}</div>
                    <div>üì∞ Detectada em <strong>${count}</strong> not√≠cia${count > 1 ? 's' : ''}</div>
                    <div style="font-size: var(--font-size-sm); color: var(--color-secondary); margin-top: var(--spacing-sm);">
                        T√©cnica cl√°ssica de contrapropaganda do Minist√©rio da Justi√ßa
                    </div>
                </div>
            `).join('');
    }

    function gerarResumoPeriodo() {
        alert('Placeholder: aqui entra a gera√ß√£o de TXT com resumo do per√≠odo.');
    }

    document.querySelectorAll('.filter-btn[data-filter]').forEach(btn => {
        btn.addEventListener('click', (ev) => {
            document.querySelectorAll('.filter-btn[data-filter]').forEach(b => b.classList.remove('active'));
            ev.target.classList.add('active');
            currentFilter = ev.target.getAttribute('data-filter');
            updateNewsTable();
        });
    });
</script>

</body>
</html>
